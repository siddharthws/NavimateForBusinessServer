var app=angular.module("navimate",["ui.router","ngStorage","angular-js-xlsx","ngMaterial","ngMap","ngTable","ngCookies","angularjs-dropdown-multiselect","ngFileSaver","angular.filter","chart.js","md.time.picker"]);app.factory("httpResponseInterceptor",["$q","$injector",function($q,$injector){return{response:function(responseData){return responseData},responseError:function(response){switch(response.status){case 401:$injector.get("$state").go("home.login");break;default:console.log("Unknown error from server : "+response.status)}return $q.reject(response)}}}]),app.filter("bytetobase",function(){return function(buffer){for(var binary="",bytes=new Uint8Array(buffer),len=bytes.byteLength,i=0;i<len;i++)binary+=String.fromCharCode(bytes[i]);return window.btoa(binary)}}),app.config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("")}]),app.config(function($stateProvider,$urlRouterProvider,$httpProvider,$compileProvider){$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|file|ftp|blob):|data:image\//),$httpProvider.interceptors.push("httpResponseInterceptor"),$urlRouterProvider.when("","/home/login"),$urlRouterProvider.when("/","/home/login"),$urlRouterProvider.when("/home","/home/login"),$urlRouterProvider.when("/dashboard","/dashboard/team/manage"),$urlRouterProvider.when("/dashboard/team","/dashboard/team/manage"),$urlRouterProvider.when("/dashboard/tasks","/dashboard/tasks/manage"),$urlRouterProvider.when("/dashboard/forms","/dashboard/forms/manage"),$stateProvider.state("home",{url:"/home",abstract:!0,templateUrl:"/static/views/home.html",controller:"HomeCtrl as vm"}).state("home.login",{url:"/login",templateUrl:"/static/views/home/login.html",controller:"LoginCtrl as vm"}).state("home.forgotPassword",{url:"/forgotPassword",templateUrl:"/static/views/home/forgotPassword.html",controller:"ForgotPasswordCtrl as vm"}).state("home.register",{url:"/register",templateUrl:"/static/views/home/register.html",controller:"RegisterCtrl as vm"}).state("home.otp",{url:"/otp",templateUrl:"/static/views/home/otp.html",controller:"OtpCtrl as vm"}).state("legal",{url:"/legal",templateUrl:"/static/views/legal.html"}).state("help",{url:"/help",templateUrl:"/static/views/help.html",controller:"HelpCtrl"}).state("dashboard-loading",{url:"/loading",templateUrl:"/static/views/dashboard/loading.html",controller:"DashboardLoadingCtrl as vm"}).state("dashboard",{abstract:!0,url:"/dashboard",templateUrl:"/static/views/dashboard.html",controller:"DashboardCtrl as vm"}).state("dashboard.team-manage",{url:"/team/manage",templateUrl:"/static/views/dashboard/team/manage.html",controller:"TeamManageCtrl as $ctrl"}).state("dashboard.leads-manage",{url:"/leads/manage",templateUrl:"/static/views/dashboard/leads/manage.html",controller:"LeadManageCtrl as $ctrl"}).state("dashboard.tasks-manage",{url:"/tasks/manage",templateUrl:"/static/views/dashboard/tasks/manage.html",controller:"TaskManageCtrl as $ctrl"}).state("dashboard.reports-submission",{url:"/submission",templateUrl:"/static/views/dashboard/reports/submission.html",controller:"SubmissionReportCtrl as $ctrl"}).state("dashboard.reports-movement",{url:"/movement",templateUrl:"/static/views/dashboard/reports/movement.html",controller:"MovementReportCtrl as $ctrl"}).state("dashboard.templates-form",{url:"/templates/form",templateUrl:"/static/views/dashboard/templates/form.html",controller:"FormTemplatesCtrl as $ctrl"}).state("dashboard.templates-lead",{url:"/templates/lead",templateUrl:"/static/views/dashboard/templates/lead.html",controller:"LeadTemplatesCtrl as $ctrl"}).state("dashboard.templates-task",{url:"/templates/task",templateUrl:"/static/views/dashboard/templates/task.html",controller:"TaskTemplatesCtrl as $ctrl"}).state("dashboard.templates-product",{url:"/templates/product",templateUrl:"/static/views/dashboard/templates/product.html",controller:"ProductTemplatesCtrl as $ctrl"}).state("dashboard.company-settings",{url:"/company/settings",templateUrl:"/static/views/dashboard/company/settings.html",controller:"CompanySettingsCtrl as $ctrl"}).state("dashboard.product-manage",{url:"/product/manage",templateUrl:"/static/views/dashboard/product/manage.html",controller:"ProductManageCtrl as vm"}).state("photos",{url:"/photos?name",templateUrl:"/static/views/photos.html",controller:"PhotosCtrl"})}),app.directive("stringToNumber",function(){return{require:"ngModel",link:function(scope,element,attrs,ngModel){ngModel.$parsers.push(function(value){return""+value}),ngModel.$formatters.push(function(value){return parseFloat(value)})}}}),app.directive("datepicker",function(){return{restrict:"E",scope:{hint:"@",modelFormat:"@",displayFormat:"@",dateModel:"=",dateChange:"&"},controller:"datepickerCtrl as vm",templateUrl:"/static/views/directives/datepicker.html"}}),app.directive("loader",function(){return{restrict:"E",templateUrl:"/static/views/directives/loader.html"}}),app.directive("loading",function(){return{restrict:"E",scope:{msg:"@",bWhite:"@"},templateUrl:"/static/views/directives/loading.html"}}),app.directive("fileread",function(){return{scope:{fileread:"&"},link:function(scope,element,attributes){element.bind("change",function(changeEvent){scope.$apply(function(){scope.fileread({file:changeEvent.target.files[0]})})})}}}),app.directive("imagebutton",function(){return{scope:{image:"@",text:"@",bTransparent:"@"},templateUrl:"/static/views/directives/imagebutton.html"}}),app.directive("ibFilepicker",function(){return{scope:{image:"@",text:"@",filePicked:"&"},templateUrl:"/static/views/directives/ibFilepicker.html",controller:"ibFilepickerCtrl"}}),app.directive("scroll",function($timeout){return{restrict:"A",scope:{onBottomReached:"&",scrollToBottom:"="},link:function(scope,element,attrs,vm){element.on("scroll",_.debounce(function(event){$(this).scrollTop()+$(this).innerHeight()>=$(this)[0].scrollHeight&&scope.onBottomReached()},500)),scope.$watch("scrollToBottom",function(){scope.scrollToBottom&&$timeout(function(){element[0].scrollTop=element[0].scrollHeight},0)})}}}),app.directive("inputBox",function(){return{restrict:"E",scope:{label:"@",hint:"@",model:"=",bNumber:"@",bSmall:"@",bShowError:"=",err:"="},templateUrl:"/static/views/directives/inputBox.html"}}),app.directive("inputUl",function(){return{restrict:"E",scope:{label:"@",type:"@",model:"=",bShowError:"=",err:"="},templateUrl:"/static/views/directives/inputUl.html"}}),app.directive("textBox",function(){return{restrict:"E",scope:{label:"@",text:"@",bShowError:"=",err:"="},templateUrl:"/static/views/directives/textBox.html"}}),app.directive("dropdown",function($timeout){return{restrict:"E",scope:{label:"@",text:"=",items:"=",onSelect:"&",bShowError:"=",err:"="},templateUrl:"/static/views/directives/dropdown.html",link:function(scope,element,attrs,vm){scope.bShowDropdown=!1,$("body").on("click",function(e){var $element=$(element),bShow=!1;bShow=!(!$element.is(e.target)&&!$element.has(e.target).length)&&(!$(e.target).hasClass("li-dropdown")||!scope.bShowDropdown),scope.bShowDropdown!=bShow&&$timeout(function(){scope.bShowDropdown=bShow},0)})}}}),app.directive("searchSelect",function($timeout){return{restrict:"E",scope:{hint:"@",name:"@",onSelect:"&"},controller:"SearchSelectCtrl as vm",templateUrl:"/static/views/directives/searchSelect.html",link:function(scope,element,attrs,vm){vm.hint=attrs.hint,vm.name=attrs.name,$("body").on("click",function(e){if(vm.bShowDropdown){var $element=$(element);$element.is(e.target)||$element.has(e.target).length||$timeout(function(){vm.bShowDropdown=!1},0)}})}}}),app.directive("searchAddress",function($timeout){return{restrict:"E",scope:{onSelect:"&"},controller:"SearchAddressCtrl as vm",templateUrl:"/static/views/directives/searchAddress.html",link:function(scope,element,attrs,vm){$("body").on("click",function(e){var $element=$(element),bShow=!1;bShow=!(!$element.is(e.target)&&!$element.has(e.target).length)&&(!$(e.target).hasClass("li-dropdown")||!vm.bShowDropdown),vm.bShowDropdown!=bShow&&$timeout(function(){vm.bShowDropdown=bShow},0)})}}}),app.directive("pager",function(){return{restrict:"E",scope:{pageCount:"=",onPageChanged:"&"},controller:"PagerCtrl as vm",templateUrl:"/static/views/directives/pager.html"}}),app.directive("pickNView",function(){return{restrict:"E",scope:{label:"@",text:"=",onPick:"&",onView:"&",bShowError:"=",err:"="},templateUrl:"/static/views/directives/pickNView.html"}}),app.directive("checklist",function(){return{restrict:"E",scope:{label:"@",value:"="},templateUrl:"/static/views/directives/checklist.html"}}),app.directive("radiolist",function(){return{restrict:"E",scope:{label:"@",value:"="},templateUrl:"/static/views/directives/radiolist.html"}}),app.directive("templateValuesEditor",function(){return{restrict:"E",scope:{bShowError:"=",values:"="},templateUrl:"/static/views/directives/templateValuesEditor.html"}}),app.directive("templateValuesViewer",function(){return{restrict:"E",scope:{values:"="},controller:"TemplateValuesViewerCtrl as vm",templateUrl:"/static/views/directives/templateValuesViewer.html"}}),app.directive("nvMap",function(){return{restrict:"E",scope:{objMap:"=",onMarkerClick:"&"},controller:"NvMapCtrl as vm",templateUrl:"/static/views/directives/nvMap.html"}}),app.controller("CompanySettingsCtrl",function($scope,$localStorage,$rootScope,$http,ToastService,NavService){var vm=this;function initTime(){vm.dayStart=new Date(0,0,0,$localStorage.startHr,0,0,0),vm.dayEnd=new Date(0,0,0,$localStorage.endHr,0,0,0)}NavService.setActive(NavService.company,0),vm.message={hour:"Hour is required",minute:"Minute is required",meridiem:"Meridiem is required"},vm.companyName=$localStorage.companyName,vm.apiKey=$localStorage.apiKey,vm.companySize=$localStorage.companySize,vm.update=function(){var startHr=vm.dayStart.getHours(),endHr=vm.dayEnd.getHours();endHr<=startHr?ToastService.toast("Day End must be greater than Day Start!!!"):($rootScope.showWaitingDialog("Please wait while settings are updating..."),$http({method:"POST",url:"/api/admin/accSettings",headers:{"X-Auth-Token":$localStorage.accessToken},data:{startHr:startHr,endHr:endHr}}).then(function(response){$localStorage.startHr=startHr,$localStorage.endHr=endHr,initTime(),$rootScope.hideWaitingDialog(),ToastService.toast("Settings Successfully Updated!!!")},function(error){$rootScope.hideWaitingDialog(),ToastService.toast("Failed to Update settings!!!")}))},initTime()}),app.controller("DashboardLoadingCtrl",function($rootScope,$localStorage,$state,TemplateService,TeamService){var bError=!1,bTemplateSync=!1,bManagerSync=!1;function syncCb(){bError||bTemplateSync&&bManagerSync&&($rootScope.bAppLoaded=!0,$localStorage.lastKnownState?$state.go($localStorage.lastKnownState):$state.go("dashboard.team-manage"))}function errorCb(){bError=!0,$state.go("home.login")}TemplateService.sync().then(function(){bTemplateSync=!0,syncCb()},function(){errorCb()}),$localStorage.role>=Constants.Role.CC?TeamService.syncManagers().then(function(){bManagerSync=!0,syncCb()},function(){errorCb()}):bManagerSync=!0}),app.controller("FormTemplatesCtrl",function($scope,$rootScope,$http,$localStorage,$state,DialogService,ToastService,TemplateService,NavService){var vm=this;function init(){vm.templates=TemplateService.getByType(Constants.Template.TYPE_FORM),vm.selection=[],vm.templates&&vm.templates.forEach(function(){vm.selection.push(!1)})}NavService.setActive(NavService.templates,0),vm.selection=[],vm.templates=[],vm.bCheckAll=!1,vm.edit=function(){var selectedItems=vm.getSelectedItems();1!=selectedItems.length?ToastService.toast("Please select a single template to edit..."):DialogService.formTemplateEditor(selectedItems[0],function(){TemplateService.sync().then(init)})},vm.create=function(){DialogService.formTemplateEditor(null,function(){TemplateService.sync().then(init)})},vm.toggleAll=function(){for(var i=0;i<vm.selection.length;i++)vm.selection[i]=vm.bCheckAll},vm.getSelectedItems=function(){for(var selectedItems=[],i=0;i<vm.selection.length;i++)vm.selection[i]&&selectedItems.push(vm.templates[i]);return selectedItems},vm.remove=function(){DialogService.confirm("Are you sure you want to remove these "+vm.getSelectedItems().length+" templates ?",function(){var templateIds=[];vm.getSelectedItems().forEach(function(template){templateIds.push(template.id)}),$rootScope.showWaitingDialog("Removing Templates..."),$http({method:"POST",url:"/api/admin/templates/remove",headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:templateIds}}).then(function(response){$rootScope.hideWaitingDialog(),ToastService.toast("Templates removed successfully..."),TemplateService.sync().then(init)},function(error){$rootScope.hideWaitingDialog(),ToastService.toast(error.data.error)})})},TemplateService.cache.length?init():TemplateService.sync().then(init)}),app.controller("LeadManageCtrl",function($scope,$rootScope,$http,$localStorage,$state,DialogService,ToastService,TableService,ImportService,NavService,LeadService){var vm=this;NavService.setActive(NavService.leads,0),TableService.activeTable=LeadService.table,vm.table=TableService.activeTable,vm.add=function(){DialogService.leadEditor(null,vm.reset)},vm.edit=function(){DialogService.leadEditor(vm.table.getSelectedIds(),vm.reset)},vm.import=function(file){$rootScope.showWaitingDialog("Importing leads. This may take some time..."),ImportService.import("/api/manager/leads/import",file).then(function(){vm.reset(),$rootScope.hideWaitingDialog(),ToastService.toast("Leads imported successfully...")},function(message){$rootScope.hideWaitingDialog(),DialogService.alert("Upload Error : "+message)})},vm.export=function(){$scope.$broadcast(Constants.Events.TABLE_EXPORT)},vm.reset=function(){$scope.$broadcast(Constants.Events.TABLE_RESET)},vm.toggleColumns=function(){$scope.$broadcast(Constants.Events.TABLE_TOGGLE_COLUMNS)},vm.sync=function(){$scope.$broadcast(Constants.Events.TABLE_SYNC)},vm.reset=function(){$scope.$broadcast(Constants.Events.TABLE_RESET)},vm.remove=function(){DialogService.confirm("Are you sure you want to remove "+vm.table.selection.length+" leads ?",function(){$rootScope.showWaitingDialog("Please wait while we are removing leads..."),$http({method:"POST",url:"/api/manager/leads/remove",headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:vm.table.getSelectedIds()}}).then(function(response){$rootScope.hideWaitingDialog(),vm.table.selection=[],vm.sync(),ToastService.toast("leads removed...")},function(error){$rootScope.hideWaitingDialog(),ToastService.toast("Failed to remove leads!!!")})})}}),app.controller("LeadTemplatesCtrl",function($scope,$rootScope,$http,$localStorage,$state,DialogService,ToastService,TemplateService,NavService){var vm=this;function init(){vm.templates=TemplateService.getByType(Constants.Template.TYPE_LEAD),vm.selection=[],vm.templates&&vm.templates.forEach(function(){vm.selection.push(!1)})}NavService.setActive(NavService.templates,1),vm.selection=[],vm.templates=[],vm.bCheckAll=!1,vm.edit=function(){var selectedItems=vm.getSelectedItems();1!=selectedItems.length?ToastService.toast("Please select a single template to edit..."):DialogService.leadTemplateEditor(selectedItems[0],function(){TemplateService.sync().then(init)})},vm.create=function(){DialogService.leadTemplateEditor(null,function(){TemplateService.sync().then(init)})},vm.toggleAll=function(){for(var i=0;i<vm.selection.length;i++)vm.selection[i]=vm.bCheckAll},vm.getSelectedItems=function(){for(var selectedItems=[],i=0;i<vm.selection.length;i++)vm.selection[i]&&selectedItems.push(vm.templates[i]);return selectedItems},vm.remove=function(){DialogService.confirm("Are you sure you want to remove these "+vm.getSelectedItems().length+" templates ?",function(){var templateIds=[];vm.getSelectedItems().forEach(function(template){templateIds.push(template.id)}),$rootScope.showWaitingDialog("Removing Templates..."),$http({method:"POST",url:"/api/admin/templates/remove",headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:templateIds}}).then(function(response){$rootScope.hideWaitingDialog(),ToastService.toast("Templates removed successfully..."),TemplateService.sync().then(init)},function(error){$rootScope.hideWaitingDialog(),ToastService.toast(error.data.error)})})},TemplateService.cache.length?init():TemplateService.sync().then(init)}),app.controller("MovementReportCtrl",function($rootScope,$scope,$timeout,NavService,LocReportDS,DialogService,TableService,ObjMap,ObjMarker,ObjPolyline){var vm=this;function cbPlay(){var polyline=vm.map.polylines[0],marker=vm.map.markers[0],reportObj=vm.report[polyline.path.length];marker.position=new google.maps.LatLng(reportObj.latitude,reportObj.longitude),reportObj.time&&(marker.name=reportObj.time),polyline.path.push([reportObj.latitude,reportObj.longitude]),polyline.path.length<vm.report.length?$timeout(cbPlay,16):($timeout(updateMap,1e3),vm.bPlaying=!1)}function updateMap(){var polylines=[],markers=[];if(vm.report.length){for(var changeIdxs=[0],i=0;i<vm.report.length-1;i++)vm.report[i].status!=vm.report[i+1].status&&changeIdxs.push(i+1);for(i=0;i<changeIdxs.length;i++){for(var firstIndex=changeIdxs[i],lastIndex=i!=changeIdxs.length-1?changeIdxs[i+1]:vm.report.length-1,polyColor=vm.report[firstIndex].status==Constants.Tracking.ERROR_NONE?"#37bcf2":"#ff0000",polyline=new ObjPolyline([],polyColor),j=firstIndex;j<=lastIndex;j++)polyline.path.push([vm.report[j].latitude,vm.report[j].longitude]);polylines.push(polyline)}vm.report.forEach(function(reportObj,i){if(reportObj.time){var marker=new ObjMarker(i,reportObj.time,new google.maps.LatLng(reportObj.latitude,reportObj.longitude));marker.bShow=!1,markers.push(marker)}}),markers.length&&(markers[0].bg=Constants.Map.MARKER_GREEN,markers[0].bShow=!0,markers[0].bExcludeFromClustering=!0,vm.startTime=markers[0].name,markers[markers.length-1].bg=Constants.Map.MARKER_RED,markers[markers.length-1].bShow=!0,markers[markers.length-1].bExcludeFromClustering=!0,vm.endTime=markers[markers.length-1].name)}vm.forms.forEach(function(form){var formMarker=new ObjMarker(form.id,null,new google.maps.LatLng(form.lat,form.lng),Constants.Map.MARKER_GREEN,"static/images/ic_report_white.png");formMarker.bExcludeFromClustering=!0,markers.push(formMarker)}),vm.map.markers=markers,vm.map.polylines=polylines,vm.map.recenter()}NavService.setActive(NavService.reports,1),vm.selectedRep=null,vm.selectedDate="",vm.report=[],vm.forms=[],vm.selection=null,vm.map=new ObjMap([]),$scope.mapParams={},vm.labels=["Active","Inactive"],vm.data=[50,50],vm.colors=["#4CAF50","#CFD8DC"],vm.options={cutoutPercentage:85},vm.startTime=null,vm.endTime=null,vm.bPlaying=!1,vm.sync=function(){vm.selectedDate&&vm.selectedRep&&(vm.report=[],$rootScope.showWaitingDialog("Getting Report..."),LocReportDS.sync(vm.selectedRep.id,vm.selectedDate).then(function(){vm.report=LocReportDS.cache.report.points,vm.distance=LocReportDS.cache.report.distance,vm.forms=LocReportDS.cache.forms,updateMap(),$rootScope.hideWaitingDialog()},function(){$rootScope.hideWaitingDialog(),DialogService.alert("Location Report not available !!!")}))},vm.pickRep=function(){DialogService.tablePicker("Pick Representative",TableService.teamTable,function(id,name){vm.selectedRep={id:id,name:name},vm.sync()})},vm.viewRep=function(){DialogService.teamViewer(vm.selectedRep.id)},vm.onMarkerClick=function(idx){var selectedMarker=vm.map.markers[idx];selectedMarker.icon?DialogService.formViewer(selectedMarker.id):vm.selection=vm.report[selectedMarker.id]},vm.play=function(){vm.map.markers=[new ObjMarker(0,"",new google.maps.LatLng(0,0))],vm.map.polylines=[new ObjPolyline([],"#37bcf2")],vm.bPlaying=!0,$timeout(cbPlay,0)}}),app.controller("ProductManageCtrl",function($scope,$rootScope,NavService){NavService.setActive(NavService.product,0)}),app.controller("ProductTemplatesCtrl",function($scope,$rootScope,$http,$localStorage,$state,DialogService,ToastService,TemplateService,NavService){var vm=this;function init(){vm.templates=TemplateService.getByType(Constants.Template.TYPE_PRODUCT),vm.selection=[],vm.templates&&vm.templates.forEach(function(){vm.selection.push(!1)})}NavService.setActive(NavService.templates,3),vm.selection=[],vm.templates=[],vm.bCheckAll=!1,vm.edit=function(){var selectedItems=vm.getSelectedItems();1!=selectedItems.length?ToastService.toast("Please select a single template to edit..."):DialogService.productTemplateEditor(selectedItems[0],function(){TemplateService.sync().then(init)})},vm.create=function(){DialogService.productTemplateEditor(null,function(){TemplateService.sync().then(init)})},vm.toggleAll=function(){for(var i=0;i<vm.selection.length;i++)vm.selection[i]=vm.bCheckAll},vm.getSelectedItems=function(){for(var selectedItems=[],i=0;i<vm.selection.length;i++)vm.selection[i]&&selectedItems.push(vm.templates[i]);return selectedItems},vm.remove=function(){DialogService.confirm("Are you sure you want to remove these "+vm.getSelectedItems().length+" templates ?",function(){var templateIds=[];vm.getSelectedItems().forEach(function(template){templateIds.push(template.id)}),$rootScope.showWaitingDialog("Removing Templates..."),$http({method:"POST",url:"/api/admin/templates/remove",headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:templateIds}}).then(function(response){$rootScope.hideWaitingDialog(),ToastService.toast("Templates removed successfully..."),TemplateService.sync().then(init)},function(error){$rootScope.hideWaitingDialog(),ToastService.toast(error.data.error)})})},TemplateService.cache.length?init():TemplateService.sync().then(init)}),app.controller("SubmissionReportCtrl",function($scope,$rootScope,$http,$localStorage,ToastService,TableService,NavService,DialogService){var vm=this;NavService.setActive(NavService.reports,0),TableService.activeTable=TableService.formTable,vm.table=TableService.activeTable,vm.sync=function(){$scope.$broadcast(Constants.Events.TABLE_SYNC)},vm.export=function(){$scope.$broadcast(Constants.Events.TABLE_EXPORT)},vm.reset=function(){$scope.$broadcast(Constants.Events.TABLE_RESET)},vm.toggleColumns=function(){$scope.$broadcast(Constants.Events.TABLE_TOGGLE_COLUMNS)},vm.remove=function(){DialogService.confirm("Are you sure you want to remove "+vm.table.selectedRows.length+" forms ?",function(){$rootScope.showWaitingDialog("Please wait while we are removing forms..."),$http({method:"POST",url:"/api/manager/forms/remove",headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:vm.table.getSelectedIds()}}).then(function(response){$rootScope.hideWaitingDialog(),vm.table.selection=[],vm.sync(),ToastService.toast("forms removed...")},function(error){$rootScope.hideWaitingDialog(),ToastService.toast("Failed to remove forms!!!")})})}}),app.controller("TaskManageCtrl",function($scope,$rootScope,$http,$localStorage,$state,DialogService,ToastService,TableService,NavService,ImportService){var vm=this;NavService.setActive(NavService.tasks,0),TableService.activeTable=TableService.taskTable,vm.table=TableService.activeTable,vm.add=function(){DialogService.taskEditor(null,vm.sync)},vm.export=function(){$scope.$broadcast(Constants.Events.TABLE_EXPORT)},vm.import=function(file){$rootScope.showWaitingDialog("Importing tasks. This may take some time..."),ImportService.import("/api/manager/tasks/import",file).then(function(){vm.sync(),$rootScope.hideWaitingDialog(),ToastService.toast("Tasks imported successfully...")},function(message){$rootScope.hideWaitingDialog(),DialogService.alert("Upload Error : "+message)})},vm.reset=function(){$scope.$broadcast(Constants.Events.TABLE_RESET)},vm.toggleColumns=function(){$scope.$broadcast(Constants.Events.TABLE_TOGGLE_COLUMNS)},vm.sync=function(){$scope.$broadcast(Constants.Events.TABLE_SYNC)},vm.edit=function(){DialogService.taskEditor(vm.table.getSelectedIds(),vm.sync)},vm.close=function(){DialogService.confirm("Are you sure you want to close these "+vm.table.selectedRows.length+" tasks ?",function(){$rootScope.showWaitingDialog("Closing Tasks..."),$http({method:"POST",url:"/api/manager/tasks/close",headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:vm.table.getSelectedIds()}}).then(function(response){$rootScope.hideWaitingDialog(),vm.sync(),ToastService.toast("Tasks closed...")},function(error){$rootScope.hideWaitingDialog(),ToastService.toast("Failed to close tasks!!!")})})},vm.remove=function(){DialogService.confirm("Are you sure you want to remove these "+vm.table.selectedRows.length+" tasks ?",function(){$rootScope.showWaitingDialog("Removing Tasks..."),$http({method:"POST",url:"/api/manager/tasks/remove",headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:vm.table.getSelectedIds()}}).then(function(response){$rootScope.hideWaitingDialog(),vm.sync(),ToastService.toast("Tasks removed successfully...")},function(error){$rootScope.hideWaitingDialog(),ToastService.toast("Failed to remove tasks!!!")})})},vm.stopRenewal=function(){DialogService.confirm("Are you sure you want to stop renewal for "+vm.table.selectedRows.length+" tasks ?",function(){$rootScope.showWaitingDialog("Stopping renewal period..."),$http({method:"POST",url:"/api/manager/tasks/stopRenewal",headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:vm.table.getSelectedIds()}}).then(function(response){$rootScope.hideWaitingDialog(),vm.sync(),ToastService.toast("renewal period stopped...")},function(error){$rootScope.hideWaitingDialog(),ToastService.toast("Failed to stop renewal!!!")})})}}),app.controller("TaskTemplatesCtrl",function($scope,$rootScope,$http,$localStorage,$state,DialogService,ToastService,TemplateService,NavService){var vm=this;function init(){vm.templates=TemplateService.getByType(Constants.Template.TYPE_TASK),vm.selection=[],vm.templates&&vm.templates.forEach(function(){vm.selection.push(!1)})}NavService.setActive(NavService.templates,2),vm.edit=function(){var selectedItems=vm.getSelectedItems();1!=selectedItems.length?ToastService.toast("Please select a single template to edit..."):DialogService.taskTemplateEditor(selectedItems[0],function(){TemplateService.sync().then(init)})},vm.create=function(){DialogService.taskTemplateEditor(null,function(){TemplateService.sync().then(init)})},vm.toggleAll=function(){for(var i=0;i<vm.selection.length;i++)vm.selection[i]=vm.bCheckAll},vm.getSelectedItems=function(){for(var selectedItems=[],i=0;i<vm.selection.length;i++)vm.selection[i]&&selectedItems.push(vm.templates[i]);return selectedItems},vm.remove=function(){DialogService.confirm("Are you sure you want to remove these "+vm.getSelectedItems().length+" templates ?",function(){var templateIds=[];vm.getSelectedItems().forEach(function(template){templateIds.push(template.id)}),$rootScope.showWaitingDialog("Removing Templates..."),$http({method:"POST",url:"/api/admin/templates/remove",headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:templateIds}}).then(function(response){$rootScope.hideWaitingDialog(),ToastService.toast("Templates removed successfully..."),TemplateService.sync().then(init)},function(error){$rootScope.hideWaitingDialog(),ToastService.toast(error.data.error)})})},$scope.nav.item=Constants.DashboardNav.Menu[Constants.DashboardNav.ITEM_TEMPLATES],$scope.nav.option=Constants.DashboardNav.Options[Constants.DashboardNav.OPTION_TASK],vm.selection=[],vm.templates=[],vm.bCheckAll=!1,TemplateService.cache.length?init():TemplateService.sync().then(init)}),app.controller("TeamManageCtrl",function($scope,$rootScope,$http,$localStorage,$state,DialogService,ToastService,TeamService,TableService,NavService,ImportService){var vm=this;NavService.setActive(NavService.team,0),TableService.activeTable=TableService.teamTable,vm.table=TableService.activeTable,vm.export=function(){$scope.$broadcast(Constants.Events.TABLE_EXPORT)},vm.import=function(file){$rootScope.showWaitingDialog("Importing team. This may take some time..."),ImportService.import("/api/admin/team/import",file).then(function(){vm.sync(),$rootScope.hideWaitingDialog(),ToastService.toast("Team imported successfully...")},function(message){$rootScope.hideWaitingDialog(),DialogService.alert("Upload Error : "+message)})},vm.reset=function(){$scope.$broadcast(Constants.Events.TABLE_RESET)},vm.toggleColumns=function(){$scope.$broadcast(Constants.Events.TABLE_TOGGLE_COLUMNS)},vm.sync=function(){$scope.$broadcast(Constants.Events.TABLE_SYNC)},vm.add=function(){DialogService.teamEditor(null,vm.sync)},vm.edit=function(){DialogService.teamEditor(vm.table.getSelectedIds(),vm.sync)},vm.track=function(){DialogService.liveTracking(vm.table.selectedRows)},vm.remove=function(){DialogService.confirm("You are about to remove "+vm.table.selectedRows.length+" members from your team. This will remove all tasks & forms associated with these users. Are you sure you want to continue ?",function(){$rootScope.showWaitingDialog("Please wait while we are removing members..."),$http({method:"POST",url:"/api/admin/team/remove",headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:vm.table.getSelectedIds()}}).then(function(response){$rootScope.hideWaitingDialog(),vm.sync(),ToastService.toast("Reps removed...")},function(error){$rootScope.hideWaitingDialog(),ToastService.toast("Failed to remove reps!!!")})})}}),app.controller("DashboardCtrl",function($scope,$rootScope,$state,$window,$localStorage,$timeout,AuthService,DialogService,ToastService,NavService,LocationService,LeadService,LocReportDS,TableService,TaskService,TeamService,TemplateService){var vm=this;$rootScope.bAppLoaded||$state.go("dashboard-loading"),vm.nav=NavService,vm.menus=[[vm.nav.team,vm.nav.leads,vm.nav.tasks],[vm.nav.reports,vm.nav.templates],[vm.nav.company]],$scope.nav={},$scope.name=$localStorage.name,$scope.role=$localStorage.role,LocationService.init(),$rootScope.isAdmin=function(){return $localStorage.role==Constants.Role.ADMIN},$rootScope.isCC=function(){return $localStorage.role==Constants.Role.CC},$scope.logout=function(){$rootScope.showWaitingDialog("Please wait while you are being logged out..."),AuthService.logout().then(function(response){$rootScope.hideWaitingDialog(),$localStorage.accessToken="",$state.go("home.login")},function(error){$rootScope.hideWaitingDialog(),console.log(error)})},$scope.changePassword=function(){DialogService.changePassword()},$scope.openHelp=function(){$window.open($state.href("help"),"_blank")},$scope.optionClicked=function(state){$state.go(state)},$scope.$on("$destroy",function(){TableService.reset(),TaskService.reset(),LeadService.reset(),LocReportDS.reset(),TemplateService.reset(),TeamService.reset()}),$timeout(function(){vm.bNoCover=!0},100)}),app.controller("AlertCtrl",function($scope,$mdDialog,message){$scope.message=message,$scope.ok=function(){$mdDialog.hide()}}),app.controller("ChangePasswordCtrl",function($scope,$rootScope,$mdDialog,$localStorage,$http,$cookies,ToastService){$scope.change=function(){(function(){if(!$scope.oldPassword||!$scope.newPassword||!$scope.confirmPassword)return $scope.bShowError=!0,ToastService.toast("Please fill all fields !!!"),!1;if($scope.newPassword!=$scope.confirmPassword)return ToastService.toast("New and confirmed passwords do not match !!!"),!1;return!0})()&&($rootScope.showWaitingDialog("Please wait while we update your password..."),$http({method:"POST",url:"/api/users/changePassword",headers:{"X-Auth-Token":$localStorage.accessToken},data:{oldPassword:$scope.oldPassword,newPassword:$scope.newPassword}}).then(function(response){if($rootScope.hideWaitingDialog(),$cookies.get(Constants.Cookie.KEY_PASSWORD)){var expireDate=new Date;expireDate.setDate(expireDate.getDate()+7),$cookies.put(Constants.Cookie.KEY_PASSWORD,$scope.newPassword,{expires:expireDate})}$mdDialog.hide(),ToastService.toast("Your password has been updated...")},function(error){$rootScope.hideWaitingDialog(),400==error.status&&ToastService.toast("Incorrect current password entered...")}))},$scope.close=function(){$mdDialog.hide()},$scope.bShowError=!1}),app.controller("ConfirmCtrl",function($scope,$mdDialog,message,yesCb){$scope.message=message,$scope.yes=function(){$mdDialog.hide(),yesCb()},$scope.no=function(){$mdDialog.hide()}}),app.controller("DateTimePickerCtrl",function($scope,$mdDialog,$timeout,date,cb){var vm=this;vm.message={hour:"Hour is required",minute:"Minute is required",meridiem:"Meridiem is required"},vm.pick=function(){var pickedDate=new Date(vm.date.getFullYear(),vm.date.getMonth(),vm.date.getDate(),vm.time.getHours(),vm.time.getMinutes(),vm.time.getSeconds(),vm.time.getMilliseconds());cb(pickedDate),$mdDialog.hide()},vm.clear=function(){cb(null),$mdDialog.hide()},vm.close=function(){$mdDialog.hide()},date||(date=new Date),vm.date=new Date(date.getTime()),vm.time=new Date(date.getTime())}),app.controller("FieldSettingsCtrl",function($scope,$rootScope,$mdDialog,field){this.field=field,this.Const=$rootScope.Constants.Template,this.close=function(){$mdDialog.hide()}}),app.controller("FormTemplateEditorCtrl",function($scope,$rootScope,$mdDialog,ObjTemplate,ToastService,TemplateService,template,cb){this.close=function(){$mdDialog.hide()},this.save=function(){$scope.$broadcast(Constants.Events.TEMPLATE_VALIDATE)},$scope.template=template?template.Clone():new ObjTemplate(null,"",Constants.Template.TYPE_FORM,[]),$scope.availableFieldTypes=Constants.Template.FORM_FIELD_TYPES,$scope.$on(Constants.Events.TEMPLATE_VALIDATE_SUCCESS,function(event,args){!function(){$rootScope.showWaitingDialog("Please wait while template is being saved...");var templates=[];templates.push($scope.template),TemplateService.edit(templates).then(function(){$rootScope.hideWaitingDialog(),$mdDialog.hide(),ToastService.toast("Template saved successfully..."),cb()},function(){$rootScope.hideWaitingDialog(),ToastService.toast("Unable to save template")})}()})}),app.controller("FormViewerCtrl",function($scope,$mdDialog,FormService,DialogService,id){var vm=this;vm.obj=null,vm.bLoading=!1,vm.bLoadError=!1,vm.viewLocation=function(){DialogService.locationViewer([{latitude:vm.obj.lat,longitude:vm.obj.lng,title:vm.obj.rep.name}])},vm.close=function(){$mdDialog.hide()},vm.bLoading=!0,FormService.sync([id]).then(function(forms){vm.bLoading=!1,vm.obj=forms[0]},function(){vm.bLoading=!1,vm.bLoadError=!0})}),app.controller("LeadEditorCtrl",function($scope,$rootScope,$mdDialog,ToastService,TemplateService,LeadService,DialogService,ObjLead,ObjValue,ids,cb){var vm=this;vm.leads=[],vm.selectedLead={},vm.bLoading=!1,vm.bLoadError=!1,vm.bInputError=!1,vm.templates=[],TemplateService.getByType(Constants.Template.TYPE_LEAD).forEach(function(template){vm.templates.push({id:template.id,name:template.name})}),vm.add=function(){var lead=new ObjLead(null,null,"","",0,0,null,[]);vm.leads.push(lead),vm.selectedLead=lead,vm.updateTemplate(0)},vm.copy=function(){var clonedLead=vm.selectedLead.Clone();clonedLead.id=null,clonedLead.owner=null,vm.leads.push(clonedLead),vm.selectedLead=clonedLead},vm.updateTemplate=function(idx){var id=vm.templates[idx].id,template=TemplateService.getById(id);vm.selectedLead.template&&vm.selectedLead.template.id==template.id||(vm.selectedLead.template=template,vm.selectedLead.values=[],template.fields.forEach(function(field){var value=new ObjValue(JSON.parse(JSON.stringify(field.value)),field);vm.selectedLead.values.push(value)}))},vm.save=function(){if(function(){vm.bInputError=!1;for(var i=0;i<vm.leads.length;i++)if(vm.leads[i].canEdit()&&!vm.leads[i].isValid())return!(vm.bInputError=!0);return!0}()){var editableLeads=[];vm.leads.forEach(function(lead){lead.canEdit()&&editableLeads.push(lead)}),$rootScope.showWaitingDialog("Please wait while leads are edited..."),LeadService.edit(editableLeads).then(function(){$rootScope.hideWaitingDialog(),$mdDialog.hide(),ToastService.toast("Leads edited successfully..."),cb()},function(){$rootScope.hideWaitingDialog(),ToastService.toast("Unable to edit leads...")})}},vm.remove=function(idx){1==vm.leads.length&&vm.close(),vm.selectedLead==vm.leads[idx]&&(idx==vm.leads.length-1?vm.selectedLead=vm.leads[idx-1]:vm.selectedLead=vm.leads[idx+1]),vm.leads.splice(idx,1)},vm.close=function(){$mdDialog.hide()},vm.pickLocation=function(){DialogService.locationPicker(vm.selectedLead.lat,vm.selectedLead.lng,function(address,lat,lng){vm.selectedLead.address=address,vm.selectedLead.lat=lat,vm.selectedLead.lng=lng})},ids?(vm.bLoading=!0,LeadService.sync(ids).then(function(){vm.bLoading=!1,vm.leads=LeadService.cache,vm.selectedLead=vm.leads[0]},function(){vm.bLoading=!1,vm.bLoadError=!0})):vm.add()}),app.controller("LeadTemplateEditorCtrl",function($scope,$rootScope,$mdDialog,ToastService,ObjTemplate,TemplateService,template,cb){this.close=function(){$mdDialog.hide()},this.save=function(){$scope.$broadcast(Constants.Events.TEMPLATE_VALIDATE)},$scope.template=template?template.Clone():new ObjTemplate(null,"",Constants.Template.TYPE_LEAD,[]),$scope.availableFieldTypes=Constants.Template.LEAD_FIELD_TYPES,$scope.$on(Constants.Events.TEMPLATE_VALIDATE_SUCCESS,function(event,args){!function(){$rootScope.showWaitingDialog("Please wait while template is being saved...");var templates=[];templates.push($scope.template),TemplateService.edit(templates).then(function(){$rootScope.hideWaitingDialog(),$mdDialog.hide(),ToastService.toast("Template saved successfully..."),cb()},function(){$rootScope.hideWaitingDialog(),ToastService.toast("Unable to save template")})}()})}),app.controller("LeadViewerCtrl",function($scope,$mdDialog,DialogService,LeadService,id){var vm=this;vm.obj=null,vm.bLoading=!1,vm.bLoadError=!1,vm.viewLocation=function(){DialogService.locationViewer([{latitude:vm.obj.lat,longitude:vm.obj.lng,title:vm.obj.name}])},vm.close=function(){$mdDialog.hide()},vm.bLoading=!0,LeadService.sync([id]).then(function(){vm.bLoading=!1,vm.obj=LeadService.cache[0]},function(){vm.bLoading=!1,vm.bLoadError=!0})}),app.controller("LiveTrackingCtrl",function($scope,$rootScope,$mdDialog,$interval,$localStorage,ToastService,DialogService,ObjMap,ObjMarker,reps){var vm=this;vm.reps=reps,vm.selectedRep=vm.reps[0];var socket=new SockJS("/ws-endpoint"),wsClient=Stomp.over(socket),bFirstUpdate=!0,refreshCb=null,markers=[];function trackingUpdateCb(message){var msgBody=JSON.parse(message.body),rep=function(id){for(var rep=null,i=0;i<vm.reps.length;i++)vm.reps[i].id==id&&(rep=vm.reps[i]);return rep}(msgBody.repId);if(rep.status=msgBody.status,rep.lastUpdateTimeMs=msgBody.timestamp,rep.speed=msgBody.speed,msgBody.lat||msgBody.lng){var marker=vm.map.markers[vm.reps.indexOf(rep)];marker.position=new google.maps.LatLng(msgBody.lat,msgBody.lng),bFirstUpdate&&(bFirstUpdate=!1,vm.map.setCenter(marker.position))}}vm.reps.forEach(function(rep){markers.push(new ObjMarker(rep.id,rep.name,new google.maps.LatLng(0,0))),rep.status=Constants.Tracking.ERROR_WAITING}),vm.map=new ObjMap(markers),vm.refreshAll=function(){var repIds=[];vm.reps.forEach(function(rep){repIds.push(rep.id),rep.status=Constants.Tracking.ERROR_WAITING}),wsClient.send("/rxc/start-tracking",{},JSON.stringify({reps:repIds}))},vm.close=function(){$mdDialog.hide()},vm.listItemClick=function(idx){vm.selectedRep=vm.reps[idx],vm.map.selectedMarker=vm.map.markers[idx],vm.map.setCenter(vm.map.selectedMarker.position)},vm.onMarkerClick=function(idx){vm.selectedRep=vm.reps[idx]},$scope.$on("$destroy",function(){refreshCb&&$interval.cancel(refreshCb),wsClient.disconnect()}),wsClient.connect({id:$localStorage.id},function(){wsClient.subscribe("/user/txc/tracking-update",trackingUpdateCb),refreshCb=$interval(function(){},1e3),vm.refreshAll()},function(){DialogService.alert("Unable to start live tracking. Your session may have expired !!!")})}),app.controller("LocationPickerCtrl",function($scope,$mdDialog,GoogleApiService,ToastService,lat,lng,cb){var vm=this;vm.address="",vm.lat=lat,vm.lng=lng,vm.bConverting=!1,$scope.mapParams={},$scope.mapParams.lat=vm.lat,$scope.mapParams.lng=vm.lng,$scope.mapParams.markers=[],vm.addressUpdated=function(address){vm.address=address,vm.bConverting=!0,GoogleApiService.addressToLatlng(address).then(function(latlng){vm.bConverting=!1,vm.lat=latlng.lat,vm.lng=latlng.lng,$scope.$broadcast(Constants.Events.MAP_CENTER,{latitude:vm.lat,longitude:vm.lng})},function(){vm.bConverting=!1,ToastService.toast("Could not get lat, lng from address")})},vm.close=function(){$mdDialog.hide()},vm.pick=function(){var latlng=$scope.mapParams.getCenter();latlng.latitude||latlng.longitude?vm.lat==latlng.latitude&&vm.lng==latlng.longitude&&vm.address?($mdDialog.hide(),cb(vm.address,vm.lat,vm.lng)):(vm.bConverting=!0,GoogleApiService.latlngToAddress(latlng.latitude,latlng.longitude).then(function(address){vm.bConverting=!1,$mdDialog.hide(),cb(address,latlng.latitude,latlng.longitude)},function(){vm.bConverting=!1,ToastService.toast("Unable to fetch address for this location...")})):ToastService.toast("Please select a valid place")}}),app.controller("LocationViewerCtrl",function($scope,locations){$scope.mapParams={},$scope.mapParams.markers=[],locations.forEach(function(location){$scope.mapParams.markers.push({title:location.title,latitude:location.latitude,longitude:location.longitude})})}),app.controller("ProductTemplateEditorCtrl",function($scope,$rootScope,$mdDialog,ToastService,ObjTemplate,TemplateService,template,cb){this.close=function(){$mdDialog.hide()},this.save=function(){$scope.$broadcast(Constants.Events.TEMPLATE_VALIDATE)},$scope.template=template?template.Clone():new ObjTemplate(null,"",Constants.Template.TYPE_PRODUCT,[]),$scope.availableFieldTypes=Constants.Template.PRODUCT_FIELD_TYPES,$scope.$on(Constants.Events.TEMPLATE_VALIDATE_SUCCESS,function(event,args){!function(){$rootScope.showWaitingDialog("Please wait while template is being saved...");var templates=[];templates.push($scope.template),TemplateService.edit(templates).then(function(){$rootScope.hideWaitingDialog(),$mdDialog.hide(),ToastService.toast("Template saved successfully..."),cb()},function(){$rootScope.hideWaitingDialog(),ToastService.toast("Unable to save template")})}()})}),app.controller("Table2PickerCtrl",function($scope,$mdDialog,TableService,ToastService,title,table,cb){var vm=this;TableService.activeTable=table,(vm.table=table).selection=[],$scope.tableProps={bSingleSelect:!0},vm.title=title,vm.pick=function(){if(vm.table.selection.length){var row=vm.table.selection[0];cb(row.id,row.name),vm.close()}else ToastService.toast("Select at least 1 row !!!")},vm.close=function(){$mdDialog.hide()}}),app.controller("TablePickerCtrl",function($scope,$mdDialog,TableService,ToastService,title,table,cb){var vm=this;table.selectedRows=[],TableService.activeTable=table,vm.table=table,$scope.tableProps={bSingleSelect:!0},vm.title=title,vm.pick=function(){if(vm.table.selectedRows.length){var row=vm.table.selectedRows[0];cb(row.id,row.name),vm.close()}else ToastService.toast("Select at least 1 row !!!")},vm.close=function(){vm.table.selectedRows=[],$mdDialog.hide()}}),app.controller("TaskEditorCtrl",function($scope,$rootScope,$mdDialog,$localStorage,ToastService,TemplateService,TaskService,DialogService,TableService,TeamService,LeadService,ObjTask,ObjValue,taskIds,cb){var vm=this;vm.tasks=[],vm.selectedTask={},vm.bLoading=!1,vm.bLoadError=!1,vm.bInputError=!1,vm.formTemplates=[],TemplateService.getByType(Constants.Template.TYPE_FORM).forEach(function(formTemplate){vm.formTemplates.push({id:formTemplate.id,name:formTemplate.name})}),vm.taskTemplates=[],TemplateService.getByType(Constants.Template.TYPE_TASK).forEach(function(taskTemplate){vm.taskTemplates.push({id:taskTemplate.id,name:taskTemplate.name})}),vm.managers=[],vm.managers.push({id:$localStorage.id,name:$localStorage.name}),TeamService.managers.forEach(function(manager){vm.managers.push({id:manager.id,name:manager.name})}),vm.add=function(){var task=new ObjTask(null,null,null,{id:$localStorage.id,name:$localStorage.name},null,{id:$localStorage.id,name:$localStorage.name},Constants.Task.STATUS_OPEN,0,null,null,null,[]);vm.tasks.push(task),vm.selectedTask=task,vm.updateFormTemplate(0),vm.updateTemplate(0)},vm.copy=function(){var clonedTask=vm.selectedTask.Clone();clonedTask.id=null,vm.tasks.push(clonedTask),vm.selectedTask=clonedTask},vm.updateManager=function(idx){var id=vm.managers[idx].id;if(id==$localStorage.id)vm.selectedTask.manager={id:$localStorage.id,name:$localStorage.name};else{var manager=TeamService.getManagerById(id);vm.selectedTask.manager={id:manager.id,name:manager.name}}},vm.updateFormTemplate=function(idx){var id=vm.formTemplates[idx].id;vm.selectedTask.formTemplate=TemplateService.getById(id)},vm.updateTemplate=function(idx){var id=vm.taskTemplates[idx].id,template=TemplateService.getById(id);vm.selectedTask.template&&vm.selectedTask.template.id==template.id||(vm.selectedTask.template=template,vm.selectedTask.values=[],template.fields.forEach(function(field){var value=new ObjValue(JSON.parse(JSON.stringify(field.value)),field);vm.selectedTask.values.push(value)}))},vm.save=function(){(function(){vm.bInputError=!1;for(var i=0;i<vm.tasks.length;i++)if(!vm.tasks[i].isValid())return!(vm.bInputError=!0);return!0})()&&($rootScope.showWaitingDialog("Please wait while task is created..."),TaskService.edit(vm.tasks).then(function(){$rootScope.hideWaitingDialog(),$mdDialog.hide(),ToastService.toast("Tasks Created successfully..."),cb()},function(){$rootScope.hideWaitingDialog(),ToastService.toast("Unable to create tasks...")}))},vm.remove=function(idx){1==vm.tasks.length&&vm.close(),vm.selectedTask==vm.tasks[idx]&&(idx==vm.tasks.length-1?vm.selectedTask=vm.tasks[idx-1]:vm.selectedTask=vm.tasks[idx+1]),vm.tasks.splice(idx,1)},vm.close=function(){$mdDialog.hide()},vm.pickLead=function(){DialogService.table2Picker("Pick Lead",LeadService.table,function(id,name){vm.selectedTask.lead={id:id,name:name}})},vm.viewLead=function(){DialogService.leadViewer(vm.selectedTask.lead.id)},vm.pickRep=function(){DialogService.tablePicker("Pick Representative",TableService.teamTable,function(id,name){vm.selectedTask.rep={id:id,name:name}})},vm.viewRep=function(){DialogService.teamViewer(vm.selectedTask.rep.id)},taskIds?(vm.bLoading=!0,TaskService.sync(taskIds).then(function(){vm.bLoading=!1,vm.tasks=TaskService.cache,vm.selectedTask=vm.tasks[0]},function(){vm.bLoading=!1,vm.bLoadError=!0})):vm.add()}),app.controller("TaskTemplateEditorCtrl",function($scope,$rootScope,$mdDialog,ToastService,ObjTemplate,TemplateService,template,cb){this.close=function(){$mdDialog.hide()},this.save=function(){$scope.$broadcast(Constants.Events.TEMPLATE_VALIDATE)},$scope.template=template?template.Clone():new ObjTemplate(null,"",Constants.Template.TYPE_TASK,[]),$scope.availableFieldTypes=Constants.Template.TASK_FIELD_TYPES,$scope.$on(Constants.Events.TEMPLATE_VALIDATE_SUCCESS,function(event,args){!function(){$rootScope.showWaitingDialog("Please wait while template is being saved...");var templates=[];templates.push($scope.template),TemplateService.edit(templates).then(function(){$rootScope.hideWaitingDialog(),$mdDialog.hide(),ToastService.toast("Template saved successfully..."),cb()},function(){$rootScope.hideWaitingDialog(),ToastService.toast("Unable to save template")})}()})}),app.controller("TaskViewerCtrl",function($scope,$mdDialog,TaskService,id){var vm=this;vm.obj=null,vm.bLoading=!1,vm.bLoadError=!1,vm.close=function(){$mdDialog.hide()},vm.bLoading=!0,TaskService.sync([id]).then(function(){vm.bLoading=!1,vm.obj=TaskService.cache[0]},function(){vm.bLoading=!1,vm.bLoadError=!0})}),app.controller("TeamEditorCtrl",function($scope,$rootScope,$mdDialog,$localStorage,ToastService,TeamService,ObjUser,ids,cb){var vm=this;vm.team=[],vm.selectedUser=null,vm.bLoading=!1,vm.bLoadError=!1,vm.bInputError,vm.managers=[],vm.managers.push({id:$localStorage.id,name:$localStorage.name}),TeamService.managers.forEach(function(manager){vm.managers.push({id:manager.id,name:manager.name})}),vm.add=function(){var rep=new ObjUser(0,"",Constants.Role.REP,"","","",{name:$localStorage.name,id:$localStorage.id});vm.team.push(rep),vm.selectedUser=rep},vm.copy=function(){var clonedUser=vm.selectedUser.Clone();clonedUser.id=null,vm.team.push(clonedUser),vm.selectedUser=clonedUser},vm.updateManager=function(idx){var id=vm.managers[idx].id;if(id==$localStorage.id)vm.selectedUser.manager={id:$localStorage.id,name:$localStorage.name};else{var manager=TeamService.getManagerById(id);vm.selectedUser.manager={id:manager.id,name:manager.name}}},vm.remove=function(idx){1==vm.team.length&&vm.close(),vm.selectedUser==vm.team[idx]&&(idx==vm.team.length-1?vm.selectedUser=vm.team[idx-1]:vm.selectedUser=vm.team[idx+1]),vm.team.splice(idx,1)},vm.save=function(){(function(){for(var bValid=!0,i=0;i<vm.team.length;i++){var user=vm.team[i];if(!user.isValid()){bValid=!1;break}}return vm.bInputError=!bValid,bValid})()&&($rootScope.showWaitingDialog("Updating team..."),TeamService.edit(vm.team).then(function(){$rootScope.hideWaitingDialog(),$mdDialog.hide(),ToastService.toast("Team edited succesfully..."),cb()},function(errorMessage){$rootScope.hideWaitingDialog(),ToastService.toast("Error : "+errorMessage)}))},vm.close=function(){$mdDialog.hide()},ids?(vm.bLoading=!0,TeamService.sync(ids).then(function(){vm.bLoading=!1,vm.team=TeamService.cache,vm.selectedUser=vm.team[0]},function(){vm.bLoading=!1,vm.bLoadError=!0})):vm.add()}),app.controller("TeamViewerCtrl",function($scope,$mdDialog,TeamService,id){var vm=this;vm.obj=null,vm.bLoading=!1,vm.bLoadError=!1,vm.close=function(){$mdDialog.hide()},vm.bLoading=!0,TeamService.sync([id]).then(function(){vm.bLoading=!1,vm.obj=TeamService.cache[0]},function(){vm.bLoading=!1,vm.bLoadError=!0})}),app.controller("ToggleColumnsCtrl",function($scope,$mdDialog,columns){var vm=this;vm.columns=columns,vm.done=function(){$mdDialog.hide()},vm.toggleAll=function(){for(var i=0;i<vm.columns.length;i++)vm.columns[i].filter.bShow=vm.bCheckAll},vm.moveUp=function(index){0<index&&vm.columns.move(index,index-1)},vm.moveDown=function(index){index<vm.columns.length-1&&vm.columns.move(index,index+1)}}),app.controller("datepickerCtrl",function($scope,$timeout,DialogService){function handleDateChange(date){$scope.rawDate=date,$scope.rawDate?$scope.dateModel=$scope.rawDate.format($scope.modelFormat):$scope.dateModel=null,$timeout(function(){$scope.dateChange()})}$scope.rawDate=null,$scope.pickDate=function(){DialogService.dateTimePicker($scope.rawDate,handleDateChange)},$scope.dateModel&&($scope.rawDate=moment($scope.dateModel,$scope.modelFormat).toDate())}),app.controller("ibFilepickerCtrl",function($scope,$timeout){$scope.pickFile=function(){$timeout(function(){$("#file-picker")[0].value="",$("#file-picker")[0].click()},0)}}),app.controller("PagerCtrl",function($scope,$timeout){var vm=this;function refreshDisplay(){var firstPage=vm.currentPage,lastPage=vm.currentPage+5-1;lastPage>$scope.pageCount&&(lastPage=$scope.pageCount,firstPage=$scope.pageCount-5),firstPage<1&&(firstPage=1),vm.bPrevEllipses=1<firstPage,vm.bNextEllipses=lastPage<$scope.pageCount,vm.visiblePages=[];for(var i=firstPage;i<=lastPage;i++)vm.visiblePages.push(i)}vm.visiblePages=[],vm.currentPage=0,vm.bPrevEllipses=!1,vm.bNextEllipses=!1,vm.page=function(pageNum){vm.currentPage!=pageNum&&(vm.currentPage=pageNum,-1==vm.visiblePages.indexOf(vm.currentPage)&&refreshDisplay(),$scope.onPageChanged({page:pageNum}))},$scope.$watch("pageCount",function(){$scope.pageCount&&(vm.currentPage=1,refreshDisplay())}),refreshDisplay()}),app.controller("SearchAddressCtrl",function($scope,GoogleApiService){var vm=this;vm.suggestions=[],vm.bShowDropdown=!1,vm.bSearching=!1,vm.bSearchError=!1,vm.searchText="",vm.search=function(){vm.suggestions=[],vm.bSearchError=!1,vm.bSearching=!0,GoogleApiService.search(vm.searchText).then(function(results){vm.bSearching=!1,vm.suggestions=results},function(){vm.bSearching=!1,vm.bError=!0})},vm.onSelect=function(idx){var address=vm.suggestions[idx];vm.searchText=address,vm.suggestions=[],$scope.onSelect({address:address}),vm.bShowDropdown=!1}}),app.controller("SearchSelectCtrl",function($scope,$q,SearchService){var vm=this;vm.items=[],vm.bShowDropdown=!1,vm.bLoading=!1,vm.bError=!1,vm.searchText="";var pager={startIdx:0,count:Constants.Table.DEFAULT_COUNT_PER_PAGE};vm.totalResults=0;var canceller=null;function search(){vm.bLoading&&canceller.resolve(),canceller=$q.defer(),vm.bLoading=!0,SearchService.search(vm.searchText,vm.name,pager,canceller).then(function(result){vm.bLoading=!1,vm.totalResults=result.totalCount,vm.items=vm.items.concat(result.items)},function(){vm.bLoading=!1,vm.bError=!0})}vm.textChanged=function(){pager.startIdx=0,vm.items=[],search()},vm.loadMore=function(){vm.bLoading||vm.totalResults&&vm.totalResults==vm.items.length||(pager.startIdx+=pager.count,search())},vm.onItemSelected=function(idx){var item=vm.items[idx];vm.searchText=item.name,vm.items=[],$scope.onSelect({id:item.id}),vm.bShowDropdown=!1},vm.onFocused=function(){vm.bShowDropdown=!0,vm.items.length||vm.textChanged()}}),app.controller("TemplateValuesViewerCtrl",function($rootScope,$http,$localStorage,FileService,DialogService){this.showImage=function(value){$rootScope.showWaitingDialog("Downloading.."),$http({method:"GET",url:"/api/photos/get",headers:{"X-Auth-Token":$localStorage.accessToken},responseType:"arraybuffer",params:{filename:value.value}}).then(function(response){FileService.downloadPhoto(response,value.field.title+"_"+value.value),$rootScope.hideWaitingDialog()},function(error){DialogService.alert("Error while downloading !!!"),$rootScope.hideWaitingDialog()})}}),app.controller("HelpCtrl",function($scope,$location,$anchorScroll){$scope.scrollTo=function(id){$location.hash(id),$anchorScroll()}}),app.controller("ForgotPasswordCtrl",function($scope,$state,$localStorage,$cookies,AuthService,ToastService,DialogService){var vm=this;vm.bInputError=!1,vm.email="",vm.forgotPassword=function(){(function(){vm.bInputError=!1,vm.emailErr()&&(vm.bInputError=!0);return!vm.bInputError})()&&(vm.bWaiting=!0,AuthService.forgotPassword(vm.email).then(function(){ToastService.toast("Email sent succesfully..."),$state.go("home.login")},function(error){vm.bWaiting=!1,DialogService.alert("Error while sending email : "+error)}))},vm.emailErr=function(){return vm.email?-1==vm.email.indexOf("@")||-1==vm.email.indexOf(".")?"Invalid Email":null:"Email is required"}}),app.controller("LoginCtrl",function($scope,$state,$localStorage,$cookies,AuthService,ToastService,DialogService){var vm=this;vm.bInputError=!1,vm.email="",vm.password="",vm.login=function(){(function(){vm.bInputError=!1,(vm.emailErr()||vm.passwordErr())&&(vm.bInputError=!0);return!vm.bInputError})()&&(vm.bWaiting=!0,AuthService.login(vm.email,vm.password).then(function(){!function(){if(vm.bRemember){var expireDate=new Date;expireDate.setDate(expireDate.getDate()+7),$cookies.put(Constants.Cookie.KEY_EMAIL,vm.email,{expires:expireDate}),$cookies.put(Constants.Cookie.KEY_PASSWORD,vm.password,{expires:expireDate})}else $cookies.remove(Constants.Cookie.KEY_EMAIL),$cookies.remove(Constants.Cookie.KEY_PASSWORD)}(),vm.bWaiting=!1,$state.go("dashboard-loading")},function(error){vm.bWaiting=!1,DialogService.alert("Login error : "+error)}))},vm.emailErr=function(){return vm.email?-1==vm.email.indexOf("@")||-1==vm.email.indexOf(".")?"Invalid Email":null:"Email is required"},vm.passwordErr=function(){return vm.password?null:"Password is required"};var savedEmail=$cookies.get(Constants.Cookie.KEY_EMAIL),savedPassword=$cookies.get(Constants.Cookie.KEY_PASSWORD);(savedEmail||savedPassword)&&(vm.bRemember=!0,vm.email=savedEmail,vm.password=savedPassword)}),app.controller("OtpCtrl",function($scope,$state,$localStorage,$cookies,AuthService,ToastService,DialogService){var vm=this;vm.bInputError=!1,vm.otp="",vm.register=function(){(function(){if(vm.bInputError=!1,vm.otpErr())return!(vm.bInputError=!0);if(String(vm.otp)!=$scope.regInfo.otp)return DialogService.alert("Invalid OTP Entered"),!1;return!0})()&&(vm.bWaiting=!0,AuthService.register($scope.regInfo).then(function(){vm.bWaiting=!1,ToastService.toast("Registered successfully..."),$state.go("home.login")},function(error){vm.bWaiting=!1,DialogService.alert("Registration error : "+error),$state.go("home.register")}))},vm.otpErr=function(){return vm.otp?null:"Enter OTP"},$scope.regInfo&&$scope.regInfo.otp||$state.go("home.register")}),app.controller("RegisterCtrl",function($scope,$state,AuthService,DialogService,ToastService){var vm=this;vm.bInputError=!1,vm.validateRegistration=function(){(function(){vm.bInputError=!1,(vm.nameErr()||vm.emailErr()||vm.companyErr()||vm.passwordErr()||vm.confirmPasswordErr())&&(vm.bInputError=!0);return!vm.bInputError})()&&(vm.bWaiting=!0,AuthService.validateRegistration($scope.regInfo).then(function(serverOtp){vm.bWaiting=!1,$scope.regInfo.otp=serverOtp,$state.go("home.otp")},function(error){vm.bWaiting=!1,DialogService.alert("Registration error : "+error)}))},vm.nameErr=function(){if(!$scope.regInfo.name)return"Name is required"},vm.emailErr=function(){return $scope.regInfo.email?-1==$scope.regInfo.email.indexOf("@")||-1==$scope.regInfo.email.indexOf(".")?"Invalid Email":null:"Email is required"},vm.companyErr=function(){return $scope.regInfo.companyName?null:"Company name is required"},vm.passwordErr=function(){return $scope.regInfo.password?null:"Password is required"},vm.confirmPasswordErr=function(){return $scope.regInfo.confirmPassword?$scope.regInfo.confirmPassword!=$scope.regInfo.password?"Password does not match":null:"Password is required"}}),app.controller("HomeCtrl",function($scope,$state,$window){$scope.regInfo={name:"",email:"",password:"",role:Constants.Role.REGISTRATION[0],companyName:"",confirmPassword:""},this.getBtnText=function(){return"home.login"==$state.current.name?"Register":"home.register"==$state.current.name?"Login":void 0},this.isBtnVisible=function(){return"home.login"==$state.current.name||"home.register"==$state.current.name},this.btnClick=function(){"home.login"==$state.current.name?$state.go("home.register"):"home.register"==$state.current.name&&$state.go("home.login")},this.knowMore=function(){$window.open("https://www.navimateapp.com","_blank")}}),app.controller("IndexCtrl",function($scope,$rootScope){$rootScope.Constants=Constants,$rootScope.Statics=Statics,$scope.waiting={bShow:!1,message:""},$rootScope.showWaitingDialog=function(message){$scope.waiting.message=message,$scope.waiting.bShow=!0},$rootScope.hideWaitingDialog=function(){$scope.waiting.bShow=!1},Array.prototype.move=function(old_index,new_index){if(new_index>=this.length)for(var k=new_index-this.length;1+k--;)this.push(void 0);this.splice(new_index,0,this.splice(old_index,1)[0])},Array.prototype.hasDupes=function(){for(var copiedArray=this.concat().sort(),i=0;i<copiedArray.length-1;i++)if(copiedArray[i+1]==copiedArray[i]&&copiedArray[i].length)return!0;return!1}}),app.controller("MapCtrl",function($scope,ObjCluster,$timeout){var vm=this;function centerMap(latLng){googleMap&&latLng&&(latLng.lat()||latLng.lng())&&googleMap.panTo(latLng)}function initMapCenter(){if(googleMap){var mapCenter=googleMap.getCenter();if(!mapCenter.lat()&&!mapCenter.lng())if($scope.mapParams.lat||$scope.mapParams.lng)centerMap(new google.maps.LatLng($scope.mapParams.lat,$scope.mapParams.lng));else if(vm.markers.length)if(1==vm.markers.length)centerMap(new google.maps.LatLng(vm.markers[0].latitude,vm.markers[0].longitude));else{for(var bounds=new google.maps.LatLngBounds,i=0;i<vm.markers.length;i++)bounds.extend(new google.maps.LatLng(vm.markers[i].latitude,vm.markers[i].longitude));googleMap.fitBounds(bounds)}else currentLatLng&&centerMap(currentLatLng)}}vm.mapInitialized=function(map){googleMap=map,initMapCenter(),google.maps.event.trigger(googleMap,"resize"),$scope.$apply(),vm.initListeners()},vm.markerClick=function(event,idx){selectedMarker=$scope.mapParams.markers[idx],$scope.$emit(Constants.Events.MAP_MARKER_CLICK,{idx:idx})},vm.markerDragend=function(event,idx){var marker=$scope.mapParams.markers[idx];marker.latitude=event.latLng.lat(),marker.longitude=event.latLng.lng(),$scope.$emit(Constants.Events.MAP_MARKER_DRAGEND,{idx:idx})},vm.getMarkerIcon=function(idx){return idx==$scope.mapParams.markers.indexOf(selectedMarker)?{url:"/static/images/marker_selected.png",scaledSize:[40,40]}:{url:"/static/images/marker_default.png",scaledSize:[40,40]}},vm.initListeners=function(){googleMap&&google.maps.event.addListener(googleMap,"idle",function(){$timeout(function(){$scope.mapParams.bDraggable||vm.updateCluster()},0)})},vm.updateCluster=function(){if(googleMap){for(var i=clusters.length=0;i<vm.markers.length;i++)vm.markers[i].bshow=!1;for(i=0;i<vm.markers.length;i++){var latlng=new google.maps.LatLng(vm.markers[i].latitude,vm.markers[i].longitude);if(googleMap.getBounds().contains(latlng))if(0!=clusters.length){for(var bPresent=!1,j=0;j<clusters.length;j++){if(clusters[j].isMarkerInClusterBounds(latlng)){bPresent=!0;break}}if(!bPresent)(newcluster=new ObjCluster(googleMap)).addMarker(vm.markers[i]),clusters.push(newcluster)}else{var newcluster;(newcluster=new ObjCluster(googleMap)).addMarker(vm.markers[i]),clusters.push(newcluster)}}for(i=0;i<clusters.length;i++)clusters[i].markers_[0].bshow=!0}};var googleMap=null,currentLatLng=null,selectedMarker=null,clusters=[];$scope.mapParams.getCenter=function(){var latlng={latitude:0,longitude:0};if(null!=googleMap){var mapCenter=googleMap.getCenter();latlng.latitude=mapCenter.lat(),latlng.longitude=mapCenter.lng()}return latlng},$scope.mapParams.zoom=14,$scope.mapParams.polylines=[],$scope.mapParams.markers||($scope.mapParams.markers=[]),vm.markers=$scope.mapParams.markers,$scope.$watch("mapParams.markers.length",function(){vm.updateCluster()}),$scope.mapParams.markers.length&&(selectedMarker=$scope.mapParams.markers[0]),vm.markers=$scope.mapParams.markers,$scope.$on(Constants.Events.MAP_CENTER,function(event,param){centerMap(new google.maps.LatLng(param.latitude,param.longitude))}),$scope.$on(Constants.Events.MAP_MARKER_SELECTED,function(event,param){selectedMarker=$scope.mapParams.markers[param.idx]}),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(position){currentLatLng=new google.maps.LatLng(position.coords.latitude,position.coords.longitude),initMapCenter()})}),app.controller("NvMapCtrl",function($scope){this.mapInitialized=function(googleMap){$scope.objMap.initGoogleMap(googleMap),$scope.$apply()},this.markerClick=function(event,idx){$scope.objMap.selectedMarker=$scope.objMap.markers[idx],$scope.objMap.setCenter($scope.objMap.selectedMarker.position),$scope.onMarkerClick({idx:idx})}}),app.controller("Table2Ctrl",function($rootScope,$scope,$window,$state,$http,$localStorage,TableService,DialogService,ToastService,FileService){var vm=this;function sync(){vm.bError=!1,vm.bWaiting=!0,vm.table.sync().then(function(success){vm.bWaiting=!1},function(error){vm.bWaiting=!1,vm.bError=!0})}function reset(){vm.bError=!1,vm.bWaiting=!0,vm.table.reset().then(function(success){vm.bWaiting=!1},function(error){vm.bWaiting=!1,vm.bError=!0})}vm.TableConst=Constants.Table,vm.FilterConst=Constants.Filter,vm.TemplateConst=Constants.Template,vm.bError=!1,vm.bWaiting=!1,vm.table=TableService.activeTable,vm.props={bSingleSelect:!1},$scope.tableProps&&(vm.props.bSingleSelect=!!$scope.tableProps.bSingleSelect),vm.showImage=function(filename){$rootScope.showWaitingDialog("Downloading.."),$http({method:"GET",url:"/api/photos/get",headers:{"X-Auth-Token":$localStorage.accessToken},responseType:"arraybuffer",params:{filename:filename}}).then(function(response){FileService.downloadPhoto(response,vm.table.columns[colIdx].name+"_"+filename),$rootScope.hideWaitingDialog()},function(error){DialogService.alert("Error while downloading !!!"),$rootScope.hideWaitingDialog()})},vm.showLocation=function(latlng,name){var latLngArr=latlng.split(","),locations=[];locations.push({title:name,latitude:latLngArr[0],longitude:latLngArr[1]}),DialogService.locationViewer(locations)},vm.viewLead=function(id){DialogService.leadViewer(id)},vm.viewTask=function(id){DialogService.taskViewer(id)},vm.rowsPerPage=function(){var pager=vm.table.pager;pager.count<5?pager.count=5:50<pager.count&&(pager.count=50),pager.startIdx=0,sync()},vm.openPage=function(pageNum){var pager=vm.table.pager;pager.startIdx=(pageNum-1)*pager.count,sync()},vm.toggleSorting=function(colIdx){var column=vm.table.columns[colIdx],colId=column.id;switch(column.filter.sort){case Constants.Table.SORT_NONE:vm.table.sortOrder.push(colId),column.filter.sort=Constants.Table.SORT_ASC;break;case Constants.Table.SORT_ASC:column.filter.sort=Constants.Table.SORT_DESC;break;case Constants.Table.SORT_DESC:vm.table.sortOrder.splice(vm.table.sortOrder.indexOf(colId),1),column.filter.sort=Constants.Table.SORT_NONE}vm.filterUpdated()},vm.toggleBlanks=function(colIdx){var column=vm.table.columns[colIdx];column.filter.bNoBlanks=!column.filter.bNoBlanks,vm.filterUpdated()},vm.filterUpdated=function(){vm.table.pager.startIdx=0,vm.table.selection=[],sync()},vm.toggleRowSelection=function(row){var selectionIdx=vm.table.getSelectionIndex(row.id);-1!=selectionIdx?vm.table.selection.splice(selectionIdx,1):(vm.props.bSingleSelect&&(vm.table.selection=[]),vm.table.selection.push({id:row.id,name:row.name}))},vm.toggleAll=function(){if(vm.table.selection.length==vm.table.rowCount)vm.table.selection=[];else{if(vm.table.rowCount>Constants.Table.MAX_SELECTION_COUNT)return void ToastService.toast("Too many rows. Maximum "+Constants.Table.MAX_SELECTION_COUNT+" rows can be selected at once.");vm.bToggleWaiting=!0,vm.table.selectAll().then(function(response){vm.bToggleWaiting=!1},function(error){vm.bToggleWaiting=!1})}},$scope.$on(Constants.Events.TABLE_SYNC,function(event,args){sync()}),$scope.$on(Constants.Events.TABLE_RESET,function(event,args){reset()}),$scope.$on(Constants.Events.TABLE_TOGGLE_COLUMNS,function(event,args){DialogService.toggleColumns(vm.table.columns)}),$scope.$on(Constants.Events.TABLE_EXPORT,function(event,args){$rootScope.showWaitingDialog("Exporting..."),vm.table.export().then(function(success){$rootScope.hideWaitingDialog()},function(error){$rootScope.hideWaitingDialog(),ToastService.toast("Error : "+error.data.error+" !!!")})}),vm.table.columns.length||reset()}),app.controller("TableCtrl",function($rootScope,$scope,$window,$state,$http,$localStorage,TableService,DialogService,ToastService,FileService){var vm=this;function sync(bColumns){vm.bError=!1,vm.bWaiting=!0,vm.table.sync(bColumns).then(function(success){vm.bWaiting=!1},function(error){vm.bWaiting=!1,vm.bError=!0})}vm.TableConst=Constants.Table,vm.FilterConst=Constants.Filter,vm.TemplateConst=Constants.Template,vm.bError=!1,vm.bWaiting=!1,vm.table=TableService.activeTable,vm.props={bSingleSelect:!1},$scope.tableProps&&(vm.props.bSingleSelect=!!$scope.tableProps.bSingleSelect),vm.table.columns.length||sync(!0),vm.showImage=function(filename,colIdx){$rootScope.showWaitingDialog("Downloading.."),$http({method:"GET",url:"/api/photos/get",headers:{"X-Auth-Token":$localStorage.accessToken},responseType:"arraybuffer",params:{filename:filename}}).then(function(response){FileService.downloadPhoto(response,vm.table.columns[colIdx].name+"_"+filename),$rootScope.hideWaitingDialog()},function(error){ToastService.toast("Download Error : "+error.data.error),$rootScope.hideWaitingDialog(),$scope.bError=!0})},vm.showLocation=function(latlng,name){var latLngArr=latlng.split(","),locations=[];locations.push({title:name,latitude:latLngArr[0],longitude:latLngArr[1]}),DialogService.locationViewer(locations)},vm.viewLead=function(id){DialogService.leadViewer(id)},vm.viewTask=function(id){DialogService.taskViewer(id)},vm.updateCount=function(){var pager=vm.table.pager;pager.count<5?pager.count=5:50<pager.count&&(pager.count=50),pager.startIdx=0,sync(!1)},vm.openPage=function(pageNum){var pager=vm.table.pager;pager.startIdx=(pageNum-1)*pager.count,sync(!1)},vm.toggleSorting=function(colIdx){var column=vm.table.columns[colIdx],colId=column.id;switch(column.sortType){case Constants.Table.SORT_NONE:vm.table.sortOrder.push(colId),column.sortType=Constants.Table.SORT_ASC;break;case Constants.Table.SORT_ASC:column.sortType=Constants.Table.SORT_DESC;break;case Constants.Table.SORT_DESC:vm.table.sortOrder.splice(vm.table.sortOrder.indexOf(colId),1),column.sortType=Constants.Table.SORT_NONE}vm.table.pager.startIdx=0,sync(!1)},vm.toggleBlanks=function(colIdx){var column=vm.table.columns[colIdx];column.bNoBlanks=!column.bNoBlanks,vm.table.pager.startIdx=0,sync(!(vm.table.selectedRows=[]))},vm.filterUpdated=function(){vm.table.pager.startIdx=0,sync(!(vm.table.selectedRows=[]))},vm.toggleRowSelection=function(row){var selectionIdx=vm.table.getSelectionIndex(row.id);-1!=selectionIdx?vm.table.selectedRows.splice(selectionIdx,1):(vm.props.bSingleSelect&&(vm.table.selectedRows=[]),vm.table.selectedRows.push({id:row.id,name:row.name}))},vm.toggleAll=function(){if(vm.table.selectedRows.length==vm.table.totalRows)vm.table.selectedRows=[];else{if(vm.table.totalRows>Constants.Table.MAX_SELECTION_COUNT)return void ToastService.toast("Too many rows. Maximum "+Constants.Table.MAX_SELECTION_COUNT+" rows can be selected at once.");vm.bToggleWaiting=!0,vm.table.selectAll().then(function(response){vm.bToggleWaiting=!1},function(error){vm.bToggleWaiting=!1})}},$scope.$on(Constants.Events.TABLE_SYNC,function(event,args){sync(!(vm.table.selectedRows=[]))}),$scope.$on(Constants.Events.TABLE_RESET,function(event,args){vm.table.reset(),sync(!0)}),$scope.$on(Constants.Events.TABLE_TOGGLE_COLUMNS,function(event,args){DialogService.toggleColumns(vm.table.columns)}),$scope.$on(Constants.Events.TABLE_EXPORT,function(event,args){$rootScope.showWaitingDialog("Exporting..."),vm.table.export().then(function(success){$rootScope.hideWaitingDialog()},function(error){$rootScope.hideWaitingDialog(),ToastService.toast("Error : "+error.data.error+" !!!")})})}),app.controller("TemplateEditorCtrl",function($scope,$rootScope,ToastService,ObjField,DialogService){var vm=this;vm.Const=$rootScope.Constants.Template,vm.addNewField=function(){vm.fields.push(new ObjField(null,"",vm.Const.FIELD_TYPE_TEXT,""))},vm.removeField=function(fieldIdx){vm.fields.splice(fieldIdx,1)},vm.fieldSettings=function(fieldIdx){DialogService.FieldSettings(vm.fields[fieldIdx])},vm.updateFieldType=function(fieldIdx,newType){var value,field=vm.fields[fieldIdx];field.type!=newType&&(newType==vm.Const.FIELD_TYPE_TEXT||newType==vm.Const.FIELD_TYPE_PHOTO||newType==vm.Const.FIELD_TYPE_FILE||newType==vm.Const.FIELD_TYPE_SIGN||newType==vm.Const.FIELD_TYPE_DATE?value="":newType==vm.Const.FIELD_TYPE_NUMBER?value=0:newType==vm.Const.FIELD_TYPE_RADIOLIST?value={options:[],selection:0}:newType==vm.Const.FIELD_TYPE_CHECKLIST?value=[]:newType==vm.Const.FIELD_TYPE_CHECKBOX&&(value=!1),field.type=newType,field.value=value)},vm.isDupeFieldTitle=function(title){if(!title)return!1;var count=0;return vm.fields.forEach(function(field){field.title==title&&count++}),1<count},vm.addRadioOption=function(fieldIdx){vm.fields[fieldIdx].value.options.push("")},vm.removeRadioOption=function(fieldIdx,optionIdx){var value=vm.fields[fieldIdx].value;value.selection==optionIdx&&(value.selection=0),value.options.splice(optionIdx,1)},vm.addCheckOption=function(fieldIdx){vm.fields[fieldIdx].value.push({name:"",selection:!1})},vm.removeCheckOption=function(fieldIdx,optionIdx){vm.fields[fieldIdx].value.splice(optionIdx,1)},vm.isDupesInChecklist=function(fieldIdx){var value=vm.fields[fieldIdx].value,names=[];return value.forEach(function(option){names.push(option.name)}),names.hasDupes()},vm.template=$scope.template,vm.availableFieldTypes=$scope.availableFieldTypes,vm.fields=vm.template.fields,vm.bShowError=!1,$scope.$on(Constants.Events.TEMPLATE_VALIDATE,function(event,args){!function(){var toastMessage="";if(vm.template.name){if(vm.fields.length)for(var i=0;i<vm.fields.length;i++){var field=vm.fields[i],value=field.value;if(field.title)if(vm.isDupeFieldTitle(field.title))toastMessage="Field titles must be unique...";else if(field.type){if(field.type==vm.Const.FIELD_TYPE_NUMBER&&null==value)toastMessage="Number field must have a numeric value...";else if(field.type==vm.Const.FIELD_TYPE_RADIOLIST)value.options.length?-1!=value.options.indexOf("")?toastMessage="Please enter valid option name...":value.options.hasDupes()&&(toastMessage="Option names must be unique..."):toastMessage="Please add atleast 1 option to list...";else if(field.type==vm.Const.FIELD_TYPE_CHECKLIST)if(value.length){if(vm.isDupesInChecklist(i))toastMessage="Option names must be unique...";else for(var j=0;j<value.length;j++)if(!value[j].name){toastMessage="Please enter valid option name...";break}}else toastMessage="Please add atleast 1 option to list..."}else toastMessage="Field type cannot be empty...";else toastMessage="Field Title cannot be empty...";if(toastMessage.length)break}}else toastMessage="Please fill template name...";toastMessage.length?(vm.bShowError=!0,ToastService.toast(toastMessage)):(vm.bShowError=!1,$scope.$emit(Constants.Events.TEMPLATE_VALIDATE_SUCCESS))}()})}),app.controller("PhotosCtrl",function($scope,$rootScope,$localStorage,$stateParams,$http){var photoName;$scope.image=[],$scope.bError=!1,(photoName=$stateParams.name)?($rootScope.showWaitingDialog("Getting Photo.."),$http({method:"GET",url:"/api/photos/get",headers:{"X-Auth-Token":$localStorage.accessToken},params:{filename:photoName}}).then(function(response){$rootScope.hideWaitingDialog(),$scope.image=response.data.image},function(error){$rootScope.hideWaitingDialog(),$scope.bError=!0})):$scope.bError=!0});var Constants={Cookie:{KEY_EMAIL:"Navm8Email",KEY_PASSWORD:"Navm8Password"},Events:{TABLE_INIT:"event_table_init",TABLE_EXPORT:"event_table_export",TABLE_TOGGLE_COLUMNS:"event_table_toggle_columns",TABLE_SYNC:"event_table_sync",TABLE_RESET:"event_table_reset",TEMPLATE_VALIDATE:"event_template_validate",TEMPLATE_VALIDATE_SUCCESS:"event_template_validate_success",MAP_CENTER:"evt-map-center",MAP_MARKER_CLICK:"evt-marker-click",MAP_MARKER_DRAGEND:"evt-marker-dragend",MAP_MARKER_SELECTED:"evt-marker-selected"},Tracking:{ERROR_NONE:0,ERROR_IDLE:1,ERROR_WAITING:2,ERROR_NO_UPDATES:3,ERROR_NO_GPS:4,ERROR_NO_PERMISSION:5,ERROR_OFFLINE:6,STATUS_MESSAGES:["Active","Idle","Waiting for location","Waiting...","GPS is disabled","Location permission denied","Phone is offline / switched off"]},DashboardNav:{ITEM_TEAM:0,ITEM_LEADS:1,ITEM_TASKS:2,ITEM_REPORTS:3,ITEM_TEMPLATES:4,ITEM_COMPANY:5,OPTION_MANAGE:0,OPTION_SUBMISSION:1,OPTION_FORM:2,OPTION_LEAD:3,OPTION_TASK:4,OPTION_PROFILE:5,OPTION_SETTINGS:6,OPTION_MOVEMENT:7},Role:{REP:1,MANAGER:2,CC:3,ADMIN:4,NVM_ADMIN:5}};Constants.Role.REGISTRATION=[{id:Constants.Role.ADMIN,name:"Admin"},{id:Constants.Role.CC,name:"Customer Care"},{id:Constants.Role.MANAGER,name:"Manager"}],Constants.Visibility={PUBLIC:1,PRIVATE:2},Constants.DashboardNav.Options=[{id:Constants.DashboardNav.OPTION_MANAGE,name:"Manage",state:"manage"},{id:Constants.DashboardNav.OPTION_SUBMISSION,name:"Submission",state:"submission"},{id:Constants.DashboardNav.OPTION_FORM,name:"Form",state:"form"},{id:Constants.DashboardNav.OPTION_LEAD,name:"Lead",state:"lead"},{id:Constants.DashboardNav.OPTION_TASK,name:"Task",state:"task"},{id:Constants.DashboardNav.OPTION_PROFILE,name:"Profile",state:"profile"},{id:Constants.DashboardNav.OPTION_SETTINGS,name:"Settings",state:"settings"},{id:Constants.DashboardNav.OPTION_MOVEMENT,name:"Movement",state:"movement"}],Constants.DashboardNav.Menu=[{id:Constants.DashboardNav.ITEM_TEAM,name:"Team",state:"team",accessLevel:Constants.Role.MANAGER,options:[Constants.DashboardNav.Options[Constants.DashboardNav.OPTION_MANAGE]]},{id:Constants.DashboardNav.ITEM_LEADS,name:"Leads",state:"leads",accessLevel:Constants.Role.MANAGER,options:[Constants.DashboardNav.Options[Constants.DashboardNav.OPTION_MANAGE]]},{id:Constants.DashboardNav.ITEM_TASKS,name:"Tasks",state:"tasks",accessLevel:Constants.Role.MANAGER,options:[Constants.DashboardNav.Options[Constants.DashboardNav.OPTION_MANAGE]]},{id:Constants.DashboardNav.ITEM_REPORTS,name:"Reports",state:"reports",accessLevel:Constants.Role.MANAGER,options:[Constants.DashboardNav.Options[Constants.DashboardNav.OPTION_SUBMISSION]]},{id:Constants.DashboardNav.ITEM_TEMPLATES,name:"Templates",state:"templates",accessLevel:Constants.Role.ADMIN,options:[Constants.DashboardNav.Options[Constants.DashboardNav.OPTION_FORM],Constants.DashboardNav.Options[Constants.DashboardNav.OPTION_LEAD],Constants.DashboardNav.Options[Constants.DashboardNav.OPTION_TASK]]},{id:Constants.DashboardNav.ITEM_COMPANY,name:"Company",state:"company",accessLevel:Constants.Role.ADMIN,options:[Constants.DashboardNav.Options[Constants.DashboardNav.OPTION_SETTINGS]]}],Constants.Table={TYPE_INVALID:0,TYPE_LEAD:1,TYPE_TASK:2,TYPE_FORM:3,TYPE_TEAM:4,COL_SIZE_S:1,COL_SIZE_M:2,COL_SIZE_L:3,SORT_NONE:0,SORT_ASC:1,SORT_DESC:-1,URL_PREFIX:["invalid","leads","tasks","forms","team"],DEFAULT_COUNT_PER_PAGE:10,MAX_SELECTION_COUNT:500,ID_LEAD_NAME:0,ID_LEAD_ADDRESS:1,ID_LEAD_LOCATION:2,ID_LEAD_TEMPLATE:3,ID_LEAD_LAST:3},Constants.Task={STATUS_OPEN:1,STATUS_CLOSED:2},Constants.Task.STATUS_NAME=["","OPEN","CLOSED"],Constants.Template={TYPE_FORM:1,TYPE_LEAD:2,TYPE_TASK:3,TYPE_PRODUCT:4,FIELD_TYPE_TEXT:1,FIELD_TYPE_NUMBER:2,FIELD_TYPE_RADIOLIST:3,FIELD_TYPE_CHECKLIST:4,FIELD_TYPE_PHOTO:5,FIELD_TYPE_SIGN:6,FIELD_TYPE_LOCATION:7,FIELD_TYPE_CHECKBOX:8,FIELD_TYPE_DATE:9,FIELD_TYPE_FILE:10,FIELD_TYPE_LEAD:21,FIELD_TYPE_TASK:22,FIELD_NAMES:["","Text","Number","Radio List","Checklist","Photo","Signature","Location","Checkbox","Date","File Upload"]},Constants.Template.FORM_FIELD_TYPES=[Constants.Template.FIELD_TYPE_TEXT,Constants.Template.FIELD_TYPE_NUMBER,Constants.Template.FIELD_TYPE_RADIOLIST,Constants.Template.FIELD_TYPE_CHECKLIST,Constants.Template.FIELD_TYPE_PHOTO,Constants.Template.FIELD_TYPE_FILE,Constants.Template.FIELD_TYPE_SIGN,Constants.Template.FIELD_TYPE_CHECKBOX,Constants.Template.FIELD_TYPE_DATE],Constants.Template.LEAD_FIELD_TYPES=[Constants.Template.FIELD_TYPE_TEXT,Constants.Template.FIELD_TYPE_NUMBER,Constants.Template.FIELD_TYPE_RADIOLIST,Constants.Template.FIELD_TYPE_CHECKLIST,Constants.Template.FIELD_TYPE_CHECKBOX,Constants.Template.FIELD_TYPE_DATE],Constants.Template.TASK_FIELD_TYPES=[Constants.Template.FIELD_TYPE_TEXT,Constants.Template.FIELD_TYPE_NUMBER,Constants.Template.FIELD_TYPE_RADIOLIST,Constants.Template.FIELD_TYPE_CHECKLIST,Constants.Template.FIELD_TYPE_CHECKBOX,Constants.Template.FIELD_TYPE_DATE],Constants.Template.PRODUCT_FIELD_TYPES=[Constants.Template.FIELD_TYPE_TEXT,Constants.Template.FIELD_TYPE_NUMBER,Constants.Template.FIELD_TYPE_RADIOLIST,Constants.Template.FIELD_TYPE_CHECKLIST,Constants.Template.FIELD_TYPE_CHECKBOX,Constants.Template.FIELD_TYPE_DATE],Constants.Filter={TYPE_NONE:0,TYPE_SELECTION:1,TYPE_TEXT:2,TYPE_NUMBER:3,TYPE_DATE:4,TYPE_OBJECT:5},Constants.Date={FORMAT_LONG:"YYYY-MM-DD HH:mm:ss",FORMAT_SHORT:"D/MM h:mm A",FORMAT_DESCRIPTIVE:"DD MMM YYYY h:mm A",FORMAT_DATE_ONLY:"DD MMMM YYYY",FORMAT_FILE_SUFFIX:"_DD_MM_YY_HHmm"},Constants.Map={DEFAULT_ZOOM:14,MARKER_DEFAULT:1,MARKER_GREEN:2,MARKER_RED:3};var Statics={getArray:function(size){return new Array(size)},absorbEvent:function(event){event.stopPropagation()},getFormattedElapsedTime:function(timeMs){var elapsedTimeS=(Date.now()-timeMs)/1e3,timeText="",unitText="";return elapsedTimeS<60?(timeText=Math.round(elapsedTimeS),unitText="second"):elapsedTimeS<3600?(timeText=Math.round(elapsedTimeS/60),unitText="minute"):elapsedTimeS<86400?(timeText=Math.round(elapsedTimeS/3600),unitText="hour"):(timeText=Math.round(elapsedTimeS/86400),unitText="day"),1<timeText&&(unitText+="s"),timeText+" "+unitText},getValueFromString:function(valueString,fieldType){var value=valueString;switch(fieldType){case Constants.Template.FIELD_TYPE_RADIOLIST:case Constants.Template.FIELD_TYPE_CHECKLIST:value&&value.length&&(value=JSON.parse(value));break;case Constants.Template.FIELD_TYPE_CHECKBOX:value="true"==value}return value},getStringFromValue:function(value,fieldType){var valueString=value;switch(fieldType){case Constants.Template.FIELD_TYPE_RADIOLIST:case Constants.Template.FIELD_TYPE_CHECKLIST:value&&(valueString=JSON.stringify(value));break;case Constants.Template.FIELD_TYPE_CHECKBOX:valueString=value?"true":"false"}return valueString},validateNumber:function(num){return!(!num&&0!=num||"null"==num)},isPositionValid:function(pos){return null!=pos&&0!=pos.lat()&&0!=pos.lng()}};Date.prototype.format=function(format){return moment(this.toString()).format(format)},app.service("AuthService",function($q,$http,$localStorage){this.validateRegistration=function(regInfo){var deferred=$q.defer();return $http({method:"POST",url:"/api/auth/validateRegistration",data:{name:regInfo.name,email:regInfo.email,password:regInfo.password,role:regInfo.role.id,companyName:regInfo.companyName}}).then(function(response){deferred.resolve(response.data.otp)},function(error){deferred.reject(error.data.error)}),deferred.promise},this.register=function(regInfo){var deferred=$q.defer();return $http({method:"POST",url:"/api/auth/register",data:{name:regInfo.name,email:regInfo.email,password:regInfo.password,role:regInfo.role.id,companyName:regInfo.companyName}}).then(function(response){deferred.resolve()},function(error){deferred.reject(error.data.error)}),deferred.promise},this.login=function(email,password){var deferred=$q.defer();return $http({method:"POST",url:"/api/auth/login",data:{email:email,password:password}}).then(function(response){!function(response){$localStorage.accessToken=response.data.accessToken,$localStorage.id=response.data.id,$localStorage.name=response.data.name,$localStorage.role=response.data.role,$localStorage.companyName=response.data.companyName,$localStorage.role==Constants.Role.ADMIN&&($localStorage.apiKey=response.data.apiKey,$localStorage.startHr=response.data.startHr,$localStorage.endHr=response.data.endHr,$localStorage.companySize=response.data.companySize)}(response),deferred.resolve()},function(error){deferred.reject(error.data.error)}),deferred.promise},this.forgotPassword=function(email){var deferred=$q.defer();return $http({method:"POST",url:"/api/auth/forgotPassword",data:{email:email}}).then(function(response){deferred.resolve()},function(error){deferred.reject(error.data.error)}),deferred.promise},this.logout=function(){return $http({method:"GET",url:"/api/auth/logout",headers:{"X-Auth-Token":$localStorage.accessToken}})}}),app.service("DialogService",function($mdDialog){this.alert=function(message){$mdDialog.show({templateUrl:"/static/views/dialogs/Alert.html",controller:"AlertCtrl",clickOutsideToClose:!0,multiple:!0,locals:{message:message}})},this.confirm=function(message,yesCb){$mdDialog.show({templateUrl:"/static/views/dialogs/Confirm.html",controller:"ConfirmCtrl",clickOutsideToClose:!0,multiple:!0,locals:{message:message,yesCb:yesCb}})},this.teamEditor=function(ids,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/TeamEditor.html",controller:"TeamEditorCtrl as vm",clickOutsideToClose:!0,locals:{ids:ids,cb:cb}})},this.taskEditor=function(taskIds,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/TaskEditor.html",controller:"TaskEditorCtrl as vm",clickOutsideToClose:!0,locals:{taskIds:taskIds,cb:cb}})},this.leadEditor=function(ids,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/LeadEditor.html",controller:"LeadEditorCtrl as vm",clickOutsideToClose:!0,locals:{ids:ids,cb:cb}})},this.formTemplateEditor=function(template,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/FormTemplateEditor.html",controller:"FormTemplateEditorCtrl as $ctrl",clickOutsideToClose:!0,locals:{template:template,cb:cb}})},this.leadTemplateEditor=function(template,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/LeadTemplateEditor.html",controller:"LeadTemplateEditorCtrl as $ctrl",clickOutsideToClose:!0,locals:{template:template,cb:cb}})},this.taskTemplateEditor=function(template,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/TaskTemplateEditor.html",controller:"TaskTemplateEditorCtrl as $ctrl",clickOutsideToClose:!0,locals:{template:template,cb:cb}})},this.productTemplateEditor=function(template,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/ProductTemplateEditor.html",controller:"ProductTemplateEditorCtrl as $ctrl",clickOutsideToClose:!0,locals:{template:template,cb:cb}})},this.liveTracking=function(reps){$mdDialog.show({templateUrl:"/static/views/dialogs/LiveTracking.html",controller:"LiveTrackingCtrl as $ctrl",clickOutsideToClose:!1,locals:{reps:reps}})},this.toggleColumns=function(columns){$mdDialog.show({templateUrl:"/static/views/dialogs/ToggleColumns.html",controller:"ToggleColumnsCtrl as $ctrl",clickOutsideToClose:!0,locals:{columns:columns}})},this.changePassword=function(){$mdDialog.show({templateUrl:"/static/views/dialogs/ChangePassword.html",controller:"ChangePasswordCtrl",clickOutsideToClose:!0})},this.locationViewer=function(locations){$mdDialog.show({templateUrl:"/static/views/dialogs/LocationViewer.html",controller:"LocationViewerCtrl",clickOutsideToClose:!0,multiple:!0,locals:{locations:locations}})},this.locationPicker=function(lat,lng,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/LocationPicker.html",controller:"LocationPickerCtrl as vm",clickOutsideToClose:!0,multiple:!0,locals:{lat:lat,lng:lng,cb:cb}})},this.tablePicker=function(title,table,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/TablePicker.html",controller:"TablePickerCtrl as vm",clickOutsideToClose:!0,multiple:!0,locals:{title:title,table:table,cb:cb}})},this.table2Picker=function(title,table,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/Table2Picker.html",controller:"Table2PickerCtrl as vm",clickOutsideToClose:!0,multiple:!0,locals:{title:title,table:table,cb:cb}})},this.teamViewer=function(id){$mdDialog.show({templateUrl:"/static/views/dialogs/TeamViewer.html",controller:"TeamViewerCtrl as vm",clickOutsideToClose:!0,multiple:!0,locals:{id:id}})},this.taskViewer=function(id){$mdDialog.show({templateUrl:"/static/views/dialogs/TaskViewer.html",controller:"TaskViewerCtrl as vm",clickOutsideToClose:!0,multiple:!0,locals:{id:id}})},this.leadViewer=function(id){$mdDialog.show({templateUrl:"/static/views/dialogs/LeadViewer.html",controller:"LeadViewerCtrl as vm",clickOutsideToClose:!0,multiple:!0,locals:{id:id}})},this.formViewer=function(id){$mdDialog.show({templateUrl:"/static/views/dialogs/FormViewer.html",controller:"FormViewerCtrl as vm",clickOutsideToClose:!0,multiple:!0,locals:{id:id}})},this.FieldSettings=function(field){$mdDialog.show({templateUrl:"/static/views/dialogs/FieldSettings.html",controller:"FieldSettingsCtrl as vm",clickOutsideToClose:!0,multiple:!0,locals:{field:field}})},this.dateTimePicker=function(date,cb){$mdDialog.show({templateUrl:"/static/views/dialogs/DateTimePicker.html",controller:"DateTimePickerCtrl as vm",clickOutsideToClose:!0,multiple:!0,locals:{date:date,cb:cb}})}}),app.service("FileService",function(){this.download=function(response,filename){var contentType=response.headers("Content-Type"),linkElement=document.createElement("a");filename+="_"+moment().format(Constants.Date.FORMAT_FILE_SUFFIX)+".xls";try{var blob=new Blob([response.data],{type:contentType}),url=window.URL.createObjectURL(blob);linkElement.setAttribute("href",url),linkElement.setAttribute("download",filename);var clickEvent=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});linkElement.dispatchEvent(clickEvent)}catch(ex){console.log("Exception while downloading file : "+ex)}},this.downloadPhoto=function(response,filename){var contentType=response.headers("Content-Type"),linkElement=document.createElement("a");try{var blob=new Blob([response.data],{type:contentType}),url=window.URL.createObjectURL(blob);linkElement.setAttribute("href",url),linkElement.setAttribute("download",filename);var clickEvent=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});linkElement.dispatchEvent(clickEvent)}catch(ex){console.log("Exception while downloading file : "+ex)}}}),app.service("FormService",function($q,$http,$localStorage,ObjForm){var canceller=null,bOngoing=!1;this.sync=function(ids){bOngoing&&(canceller.resolve(),bOngoing=!1),canceller=$q.defer();var deferred=$q.defer();return bOngoing=!0,$http({method:"POST",url:"/api/manager/forms/getByIds",timeout:canceller.promise,headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:ids}}).then(function(response){bOngoing=!1;var forms=[];response.data.forEach(function(formJson){forms.push(ObjForm.fromJson(formJson))}),deferred.resolve(forms)},function(error){-1!=error.status&&(bOngoing=!1,deferred.reject())}),deferred.promise}}),app.service("GoogleApiService",function($q,$http,$localStorage){var bSearchOngoing=!1,bAddressOngoing=!1,bLatlngOngoing=!1,searchCanceller=null,addressCanceller=null,latlngCanceller=null;this.search=function(text){bSearchOngoing&&(searchCanceller.resolve(),bSearchOngoing=!1),searchCanceller=$q.defer();var deferred=$q.defer();return bSearchOngoing=!0,$http({method:"GET",url:"/api/googleapis/autocomplete",timeout:searchCanceller.promise,headers:{"X-Auth-Token":$localStorage.accessToken},params:{input:text}}).then(function(response){bSearchOngoing=!1,deferred.resolve(response.data)},function(error){-1!=error.status&&(bSearchOngoing=!1,deferred.reject())}),deferred.promise},this.addressToLatlng=function(address){bAddressOngoing&&(addressCanceller.resolve(),bAddressOngoing=!1),addressCanceller=$q.defer();var deferred=$q.defer();return bAddressOngoing=!0,$http({method:"GET",url:"/api/googleapis/geocode",timeout:addressCanceller.promise,headers:{"X-Auth-Token":$localStorage.accessToken},params:{address:address}}).then(function(response){bAddressOngoing=!1,deferred.resolve(response.data)},function(error){-1!=error.status&&(bAddressOngoing=!1,deferred.reject())}),deferred.promise},this.latlngToAddress=function(lat,lng){bLatlngOngoing&&(latlngCanceller.resolve(),bLatlngOngoing=!1),latlngCanceller=$q.defer();var deferred=$q.defer();return $http({method:"GET",url:"/api/googleapis/geocode/reverse",timeout:latlngCanceller.promise,headers:{"X-Auth-Token":$localStorage.accessToken},params:{latitude:lat,longitude:lng}}).then(function(response){bLatlngOngoing=!1,deferred.resolve(response.data.address)},function(error){-1!=error.status&&(bLatlngOngoing=!1,deferred.reject())}),deferred.promise}}),app.service("ImportService",function($q,$http,$localStorage){this.import=function(url,file){var deferred=$q.defer(),formData=new FormData;return formData.append("importFile",file),$http({method:"POST",url:url,headers:{"Content-Type":void 0,"X-Auth-Token":$localStorage.accessToken},data:formData}).then(function(response){deferred.resolve()},function(error){var errorMessage=error.data.error;deferred.reject(errorMessage)}),deferred.promise}}),app.service("LeadService",function($q,$http,$localStorage,ObjLead,TemplateService,ObjTable2,ObjColumn){var vm=this;vm.cache=null;var canceller=vm.table=null,bOngoing=!1;vm.reset=function(){vm.cache=[],vm.table=new ObjTable2(Constants.Table.TYPE_LEAD,vm.getTableColumns,vm.parseTableResponse)},vm.sync=function(ids){bOngoing&&(canceller.resolve(),bOngoing=!1),canceller=$q.defer();var deferred=$q.defer();return bOngoing=!0,$http({method:"POST",url:"/api/manager/leads/getByIds",timeout:canceller.promise,headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:ids}}).then(function(response){bOngoing=!1,vm.cache=[],response.data.forEach(function(leadJson){vm.cache.push(ObjLead.fromJson(leadJson))}),deferred.resolve()},function(error){-1!=error.status&&(bOngoing=!1,deferred.reject())}),deferred.promise},vm.edit=function(leads){var deferred=$q.defer(),leadsJson=[];return leads.forEach(function(lead){leadsJson.push(ObjLead.toJson(lead))}),$http({method:"POST",url:"/api/manager/leads/edit",headers:{"X-Auth-Token":$localStorage.accessToken},data:{leads:leadsJson}}).then(function(response){deferred.resolve()},function(error){deferred.reject(error.data.error)}),deferred.promise},vm.getById=function(id){for(var i=0;i<vm.cache.length;i++){var lead=vm.cache[i];if(lead.id==id)return lead}return null},vm.getTableColumns=function(){var columns=[],Table_C=Constants.Table,Template_C=Constants.Template;return columns.push(new ObjColumn(Table_C.ID_LEAD_NAME,"Name",Template_C.FIELD_TYPE_LEAD,null,"name")),columns.push(new ObjColumn(Table_C.ID_LEAD_ADDRESS,"Address",Template_C.FIELD_TYPE_TEXT,null,"address")),columns.push(new ObjColumn(Table_C.ID_LEAD_LOCATION,"Location",Template_C.FIELD_TYPE_LOCATION,null,"location")),columns.push(new ObjColumn(Table_C.ID_LEAD_TEMPLATE,"Template",Template_C.FIELD_TYPE_TEXT,null,"template")),TemplateService.getByType(Constants.Template.TYPE_LEAD).forEach(function(template){template.fields.forEach(function(field,i){columns.push(new ObjColumn(columns.length,field.title,field.type,field.id,String(field.id)))})}),columns},vm.parseTableResponse=function(response){var rows=[];return response.leads.forEach(function(json){var lead=ObjLead.fromJson(json);rows.push(lead.toRow(vm.table))}),rows},vm.reset()}),app.service("LocationService",function(){var vm=this;vm.curLocation=null,vm.init=function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(position){vm.curLocation=new google.maps.LatLng(position.coords.latitude,position.coords.longitude)})}}),app.service("LocReportDS",function($http,$localStorage,$q){var vm=this;vm.cache=[],vm.reset=function(){vm.cache=[]},vm.sync=function(repId,date){var deferred=$q.defer();return $http({method:"GET",url:"/api/users/locationReport",headers:{"X-Auth-Token":$localStorage.accessToken},params:{repId:repId,selectedDate:date}}).then(function(response){vm.cache=response.data,deferred.resolve(null)},function(error){deferred.reject(null)}),deferred.promise}}),app.service("NavService",function($localStorage,ObjMenu,ObjTab){var vm=this;vm.activeMenu=null,vm.team=new ObjMenu("TEAM","ic_team.png",Constants.Role.MANAGER,[new ObjTab("MANAGE","team-manage",Constants.Role.MANAGER)]),vm.leads=new ObjMenu("LEADS","ic_lead.png",Constants.Role.MANAGER,[new ObjTab("MANAGE","leads-manage",Constants.Role.MANAGER)]),vm.tasks=new ObjMenu("TASKS","ic_briefcase.png",Constants.Role.MANAGER,[new ObjTab("MANAGE","tasks-manage",Constants.Role.MANAGER)]),vm.reports=new ObjMenu("REPORTS","ic_report.png",Constants.Role.MANAGER,[new ObjTab("SUBMISSIONS","reports-submission",Constants.Role.MANAGER),new ObjTab("MOVEMENT","reports-movement",Constants.Role.MANAGER)]),vm.templates=new ObjMenu("TEMPLATES","ic_template.png",Constants.Role.ADMIN,[new ObjTab("FORM","templates-form",Constants.Role.ADMIN),new ObjTab("LEAD","templates-lead",Constants.Role.ADMIN),new ObjTab("TASK","templates-task",Constants.Role.ADMIN)]),vm.company=new ObjMenu("COMPANY","ic_company.png",Constants.Role.ADMIN,[new ObjTab("SETTINGS","company-settings",Constants.Role.ADMIN)]),vm.product=new ObjMenu("PRODUCT","ic_product.png",Constants.Role.MANAGER,[new ObjTab("MANAGE","product-manage",Constants.Role.MANAGER)]),vm.setActive=function(menu,tabIdx){vm.activeMenu=menu,vm.activeMenu.activeTab=vm.activeMenu.tabs[tabIdx],$localStorage.lastKnownState="dashboard."+vm.activeMenu.activeTab.state}}),app.service("SearchService",function($q,$http,$localStorage){this.search=function(text,name,pager,canceller){var deferred=$q.defer();return $http({method:"POST",url:"/api/manager/"+name+"/search",headers:{"X-Auth-Token":$localStorage.accessToken},timeout:canceller.promise,data:{text:text,pager:pager}}).then(function(response){deferred.resolve(response.data)},function(error){-1!=error.status&&deferred.reject()}),deferred.promise}}),app.service("TableService",function(ObjTable){var vm=this;vm.activeTable=null,vm.taskTable=new ObjTable(Constants.Table.TYPE_TASK),vm.formTable=new ObjTable(Constants.Table.TYPE_FORM),vm.teamTable=new ObjTable(Constants.Table.TYPE_TEAM),vm.reset=function(){vm.activeTable=null,vm.taskTable=new ObjTable(Constants.Table.TYPE_TASK),vm.formTable=new ObjTable(Constants.Table.TYPE_FORM),vm.teamTable=new ObjTable(Constants.Table.TYPE_TEAM)}}),app.service("TaskService",function($q,$http,$localStorage,ObjTask){var vm=this;vm.cache=[];var canceller=null,bOngoing=!1;vm.reset=function(){vm.cache=[]},vm.sync=function(ids){bOngoing&&(canceller.resolve(),bOngoing=!1),canceller=$q.defer();var deferred=$q.defer();return bOngoing=!0,$http({method:"POST",url:"/api/manager/tasks/getByIds",timeout:canceller.promise,headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:ids}}).then(function(response){bOngoing=!1,vm.cache=[],response.data.forEach(function(taskJson){vm.cache.push(ObjTask.fromJson(taskJson))}),deferred.resolve()},function(error){-1!=error.status&&(bOngoing=!1,deferred.reject())}),deferred.promise},vm.edit=function(tasks){var deferred=$q.defer(),tasksJson=[];return tasks.forEach(function(task){tasksJson.push(ObjTask.toJson(task))}),$http({method:"POST",url:"/api/manager/tasks/edit",headers:{"X-Auth-Token":$localStorage.accessToken},data:{tasks:tasksJson}}).then(function(response){deferred.resolve()},function(error){deferred.reject(error.data.error)}),deferred.promise},vm.getById=function(id){for(var i=0;i<vm.cache.length;i++){var task=vm.cache[i];if(task.id==id)return task}return null}}),app.service("TeamService",function($q,$http,$localStorage,ObjUser){var vm=this;vm.cache=[],vm.managers=[];var canceller=null,bOngoing=!1;vm.reset=function(){vm.cache=[],vm.managers=[]},vm.sync=function(ids){bOngoing&&(canceller.resolve(),bOngoing=!1),canceller=$q.defer();var deferred=$q.defer();return bOngoing=!0,$http({method:"POST",url:"/api/manager/team/getByIds",timeout:canceller.promise,headers:{"X-Auth-Token":$localStorage.accessToken},data:{ids:ids}}).then(function(response){bOngoing=!1,vm.cache=[],response.data.forEach(function(userJson){vm.cache.push(ObjUser.fromJson(userJson))}),deferred.resolve()},function(error){-1!=error.status&&(bOngoing=!1,deferred.reject())}),deferred.promise},vm.syncManagers=function(){var deferred=$q.defer();return $http({method:"POST",url:"/api/cc/team/getManagers",headers:{"X-Auth-Token":$localStorage.accessToken}}).then(function(response){vm.managers=[],response.data.forEach(function(userJson){vm.managers.push(ObjUser.fromJson(userJson))}),deferred.resolve()},function(error){deferred.reject()}),deferred.promise},vm.edit=function(team){var deferred=$q.defer(),teamJson=[];return team.forEach(function(user){teamJson.push(ObjUser.toJson(user))}),$http({method:"POST",url:"/api/admin/team/edit",headers:{"X-Auth-Token":$localStorage.accessToken},data:{team:teamJson}}).then(function(response){deferred.resolve()},function(error){deferred.reject(error.data.error)}),deferred.promise},vm.getById=function(id){for(var i=0;i<vm.cache.length;i++){var user=vm.cache[i];if(user.id==id)return user}return null},vm.getManagerById=function(id){for(var i=0;i<vm.managers.length;i++){var user=vm.managers[i];if(user.id==id)return user}return null}}),app.service("TemplateService",function($q,$http,$localStorage,ObjTemplate){var vm=this;vm.cache=[],vm.reset=function(){vm.cache=[]},vm.sync=function(){var deferred=$q.defer();return $http({method:"POST",url:"/api/manager/templates/getAll",headers:{"X-Auth-Token":$localStorage.accessToken}}).then(function(response){vm.cache=[],response.data.forEach(function(templateJson){vm.cache.push(ObjTemplate.fromJson(templateJson))}),deferred.resolve()},function(error){deferred.reject()}),deferred.promise},vm.edit=function(templates){var deferred=$q.defer(),templatesJson=[];return templates.forEach(function(template){templatesJson.push(ObjTemplate.toJson(template))}),$http({method:"POST",url:"/api/admin/templates/edit",headers:{"X-Auth-Token":$localStorage.accessToken},data:{templates:templatesJson}}).then(function(response){deferred.resolve()},function(error){deferred.reject(error.data.error)}),deferred.promise},vm.getById=function(id){for(var i=0;i<vm.cache.length;i++){var template=vm.cache[i];if(template.id==id)return template}return null},vm.getFieldById=function(id){for(var i=0;i<vm.cache.length;i++)for(var template=vm.cache[i],j=0;j<template.fields.length;j++){var field=template.fields[j];if(id==field.id)return field}return null},vm.getByType=function(type){var templates=[];return vm.cache.forEach(function(template){template.type==type&&templates.push(template)}),templates}}),app.service("ToastService",function($mdToast){this.toast=function(message){$mdToast.show($mdToast.simple().textContent(message).position("bottom center").hideDelay(3e3))}}),app.factory("ObjCluster",function(){return ObjCluster=function(map){var vm=this;vm.map_=map,vm.gridSize_=60,vm.markers_=[];var overlay=new google.maps.OverlayView;overlay.draw=function(){},overlay.setMap(map),vm.getExtendedBounds=function(bounds){var projection=overlay.getProjection();if(null==projection)return bounds;var tr=new google.maps.LatLng(bounds.getNorthEast().lat(),bounds.getNorthEast().lng()),bl=new google.maps.LatLng(bounds.getSouthWest().lat(),bounds.getSouthWest().lng()),trPix=projection.fromLatLngToDivPixel(tr);trPix.x+=vm.gridSize_,trPix.y-=vm.gridSize_;var blPix=projection.fromLatLngToDivPixel(bl);blPix.x-=vm.gridSize_,blPix.y+=vm.gridSize_;var ne=projection.fromDivPixelToLatLng(trPix),sw=projection.fromDivPixelToLatLng(blPix);return bounds.extend(ne),bounds.extend(sw),bounds},vm.isMarkerInClusterBounds=function(latlng){return vm.getExtendedBounds(vm.getBounds()).contains(latlng)},vm.getBounds=function(){for(var marker,bounds=new google.maps.LatLngBounds,i=0;marker=vm.markers_[i];i++)bounds.extend(new google.maps.LatLng(marker.latitude,marker.longitude));return bounds},vm.addMarker=function(marker){vm.markers_.push(marker)}},ObjCluster}),app.factory("ObjMap",function($timeout,LocationService){return ObjMap=function(markers){var vm=this;function clusterMarkers(){if(null!=vm.gMap){vm.markers.forEach(function(marker){marker.bShow=!1});var overlay=new google.maps.OverlayView;overlay.setMap(vm.gMap);var projection=overlay.getProjection(),visibleMarkers=[];vm.markers.forEach(function(marker){marker.bExcludeFromClustering&&(marker.bShow=!0,visibleMarkers.push(marker))});for(var i=0;i<vm.markers.length;i++){var marker=vm.markers[i];if(!marker.bExcludeFromClustering&&vm.gMap.getBounds().contains(marker.position)){for(var bShow=!0,j=0;j<visibleMarkers.length;j++){if(visibleMarkers[j].getExtendedBounds(projection).contains(marker.position)){bShow=!1;break}}(marker.bShow=bShow)&&visibleMarkers.push(marker)}}}}function idleListener(){$timeout(clusterMarkers,0)}vm.gMap=null,vm.markers=markers,vm.selectedMarker=null,vm.markers&&vm.markers.length&&(vm.selectedMarker=vm.markers[0]),vm.polylines=[],vm.initGoogleMap=function(googleMap){vm.gMap=googleMap,google.maps.event.addListener(googleMap,"idle",idleListener),vm.recenter(),google.maps.event.trigger(vm.gMap,"resize")},vm.getCenter=function(){var center=new google.maps.LatLng(0,0);return null!=vm.gMap&&(center=vm.gMap.getCenter()),center},vm.setCenter=function(position){null!=vm.gMap&&Statics.isPositionValid(position)&&(Statics.isPositionValid(vm.getCenter())||vm.gMap.setZoom(Constants.Map.DEFAULT_ZOOM),vm.gMap.panTo(position))},vm.recenter=function(){if(null!=vm.gMap){var bounds=function(){var bounds=new google.maps.LatLngBounds;vm.markers.forEach(function(marker){bounds.extend(marker.position)}),vm.polylines.forEach(function(polyline){polyline.path.forEach(function(point){bounds.extend(new google.maps.LatLng(point[0],point[1]))})});var ne=bounds.getNorthEast(),sw=bounds.getSouthWest();if(ne.equals(sw)){var extendPoint1=new google.maps.LatLng(ne.lat()+.01,sw.lng()+.01),extendPoint2=new google.maps.LatLng(ne.lat()-.01,sw.lng()-.01);bounds.extend(extendPoint1),bounds.extend(extendPoint2)}return bounds}();bounds.isEmpty()||!Statics.isPositionValid(bounds.getCenter())?Statics.isPositionValid(LocationService.curLocation)&&vm.setCenter(LocationService.curLocation):vm.gMap.fitBounds(bounds)}}},ObjMap}),app.factory("ObjMarker",function(){return ObjMarker=function(id,name,position,bg,icon){var vm=this;vm.id=id,vm.name=name,vm.position=position,vm.icon=icon,vm.bg=bg||Constants.Map.MARKER_DEFAULT,vm.bExcludeFromClustering=!1,vm.bShow=!0,vm.isShowing=function(){return Statics.isPositionValid(vm.position)&&vm.bShow},vm.getExtendedBounds=function(projection){var trPix=projection.fromLatLngToDivPixel(vm.position),blPix=projection.fromLatLngToDivPixel(vm.position);trPix.x+=40,trPix.y-=40,blPix.x-=40,blPix.y+=40;var ne=projection.fromDivPixelToLatLng(trPix),sw=projection.fromDivPixelToLatLng(blPix),bounds=new google.maps.LatLngBounds;return bounds.extend(ne),bounds.extend(sw),bounds}},ObjMarker}),app.factory("ObjPolyline",function(){return ObjPolyline=function(path,color){this.path=path||[],this.color=color||"#37bcf2"},ObjPolyline}),app.factory("ObjMenu",function($state){function ObjMenu(name,icon,access,tabs){this.name=name,this.icon=icon,this.access=access,this.tabs=tabs,this.activeTab=this.tabs[0]}return ObjMenu.prototype.select=function(){$state.go("dashboard."+this.activeTab.state)},ObjMenu.prototype.selectTab=function(idx){$state.go("dashboard."+this.tabs[idx].state)},ObjMenu}),app.factory("ObjTab",function(){return function(name,state,access){this.name=name,this.state=state,this.access=access}}),app.factory("ObjForm",function(TemplateService,ObjValue){function ObjForm(id,manager,rep,lead,task,status,lat,lng,submitTime,distance,template,values){this.id=id,this.manager=manager,this.rep=rep,this.lead=lead,this.task=task,this.status=status,this.lat=lat,this.lng=lng,this.submitTime=submitTime,this.distance=distance,this.template=template,this.values=values}return ObjForm.prototype.Clone=function(){var rep=this.rep?{id:this.rep.id,name:this.rep.name}:null,manager=this.manager?{id:this.manager.id,name:this.manager.name}:null,lead=this.lead?{id:this.lead.id,name:this.lead.name}:null,task=this.task?{id:this.task.id,name:this.task.name}:null,values=[];return this.values.forEach(function(value){values.push(value.Clone())}),new ObjForm(this.id,manager,rep,lead,task,this.status,this.lat,this.lng,this.submitTime,this.distance,this.template,values)},ObjForm.fromJson=function(json){var values=[];return json.values.forEach(function(value){values.push(ObjValue.fromJson(value))}),new ObjForm(json.id,json.rep,json.manager,json.lead,json.task,json.status,json.lat,json.lng,json.submitTime,json.distance,TemplateService.getById(json.templateId),values)},ObjForm}),app.factory("ObjLead",function($localStorage,TemplateService,ObjValue){function ObjLead(id,owner,name,address,lat,lng,template,values){this.id=id,this.owner=owner,this.name=name,this.address=address,this.lat=lat,this.lng=lng,this.template=template,this.values=values}return ObjLead.prototype.Clone=function(){var values=[];return this.values.forEach(function(value){values.push(value.Clone())}),new ObjLead(this.id,{id:this.owner.id,name:this.owner.name},this.name,this.address,this.lat,this.lng,this.template,values)},ObjLead.prototype.toRow=function(table){var values=Statics.getArray(table.columns.length);values.fill("-");var row={id:this.id,name:this.name,values:values};return row.values[Constants.Table.ID_LEAD_NAME]={id:this.id,name:this.name},row.values[Constants.Table.ID_LEAD_ADDRESS]=this.address,row.values[Constants.Table.ID_LEAD_LOCATION]=this.lat&&this.lng?this.lat+","+this.lng:"-",row.values[Constants.Table.ID_LEAD_TEMPLATE]=this.template.name,this.values.forEach(function(value){var column=table.getColumnForField(value.field);row.values[column.id]=value.getDisplayString()}),row},ObjLead.prototype.canEdit=function(){return!this.owner||this.owner.id==$localStorage.id||$localStorage.role==Constants.Role.ADMIN},ObjLead.prototype.isValid=function(){if(this.getNameErr().length)return!1;if(this.getAddressErr().length)return!1;if(this.getTemplateErr().length)return!1;for(var i=0;i<this.values.length;i++)if(0<this.values[i].getErr().length)return!1;return!0},ObjLead.prototype.getNameErr=function(){return this.name?"":"Set a name"},ObjLead.prototype.getAddressErr=function(){return this.address&&(this.lat||this.lng)?"":"Invalid Address. Select using map."},ObjLead.prototype.getTemplateErr=function(){return this.template?"":"Select a template"},ObjLead.fromJson=function(json){var values=[];return json.values.forEach(function(value){values.push(ObjValue.fromJson(value))}),new ObjLead(json.id,json.owner,json.name,json.address,json.lat,json.lng,TemplateService.getById(json.templateId),values)},ObjLead.toJson=function(lead){var valuesJson=[];return lead.values.forEach(function(value){valuesJson.push(ObjValue.toJson(value))}),{id:lead.id,name:lead.name,address:lead.address,lat:lead.lat,lng:lead.lng,templateId:lead.template.id,values:valuesJson}},ObjLead}),app.factory("ObjTask",function(TemplateService,ObjValue){function ObjTask(id,publicId,lead,manager,rep,creator,status,period,dateCreated,formTemplate,template,values){this.id=id,this.publicId=publicId,this.lead=lead,this.manager=manager,this.rep=rep,this.creator=creator,this.status=status,this.period=period,this.dateCreated=dateCreated,this.formTemplate=formTemplate,this.template=template,this.values=values}return ObjTask.prototype.Clone=function(){var lead=this.lead?{id:this.lead.id,name:this.lead.name,lat:this.lead.lat,lng:this.lead.lng}:null,manager=this.manager?{id:this.manager.id,name:this.manager.name}:null,rep=this.rep?{id:this.rep.id,name:this.rep.name}:null,creator=this.creator?{id:this.creator.id,name:this.creator.name}:null,values=[];return this.values.forEach(function(value){values.push(value.Clone())}),new ObjTask(this.id,this.publicId,lead,manager,rep,creator,this.status,this.period,this.dateCreated,this.formTemplate,this.template,values)},ObjTask.prototype.isValid=function(){if(this.getPublicIdErr().length)return!1;if(this.getLeadErr().length)return!1;if(this.getPeriodErr().length)return!1;if(this.getFormErr().length)return!1;if(this.getTemplateErr().length)return!1;for(var i=0;i<this.values.length;i++)if(0<this.values[i].getErr().length)return!1;return!0},ObjTask.prototype.getPublicIdErr=function(){return this.publicId?"":"ID is mandatory"},ObjTask.prototype.getLeadErr=function(){return this.lead?"":"Select a lead"},ObjTask.prototype.getPeriodErr=function(){return Statics.validateNumber(this.period)?"":"Cannot be empty"},ObjTask.prototype.getFormErr=function(){return this.formTemplate?"":"Select a form"},ObjTask.prototype.getTemplateErr=function(){return this.template?"":"Select a template"},ObjTask.fromJson=function(json){var values=[];return json.values.forEach(function(value){values.push(ObjValue.fromJson(value))}),new ObjTask(json.id,json.publicId,json.lead,json.manager,json.rep,json.creator,json.status,json.period,json.dateCreated,TemplateService.getById(json.formTemplateId),TemplateService.getById(json.templateId),values)},ObjTask.toJson=function(task){var valuesJson=[];return task.values.forEach(function(value){valuesJson.push(ObjValue.toJson(value))}),{id:task.id,publicId:task.publicId,leadId:task.lead.id,managerId:task.manager?task.manager.id:0,repId:task.rep?task.rep.id:null,status:task.status,period:task.period,formTemplateId:task.formTemplate.id,templateId:task.template.id,values:valuesJson}},ObjTask}),app.factory("ObjTemplate",function(ObjField){function ObjTemplate(id,name,type,fields){this.id=id,this.type=type,this.name=name,this.fields=fields}return ObjTemplate.prototype.Clone=function(){var fields=[];return this.fields.forEach(function(field){fields.push(field.Clone())}),new ObjTemplate(this.id,this.name,this.type,fields)},ObjTemplate.fromJson=function(json){var fields=[];return json.fields.forEach(function(fieldJson){fields.push(ObjField.fromJson(fieldJson))}),new ObjTemplate(json.id,json.name,json.type,fields)},ObjTemplate.toJson=function(template){var fieldsJson=[];return template.fields.forEach(function(field){fieldsJson.push(ObjField.toJson(field))}),{id:template.id,name:template.name,type:template.type,fields:fieldsJson}},ObjTemplate}),app.factory("ObjUser",function(){function ObjUser(id,name,role,phone,countryCode,email,manager,about){this.id=id,this.name=name,this.role=role,this.phone=phone,this.countryCode=countryCode,this.email=email,this.manager=manager,this.about=about}return ObjUser.prototype.Clone=function(){return new ObjUser(this.id,this.name,this.role,this.phone,this.countryCode,this.email,{name:this.manager.name,id:this.manager.id},this.about)},ObjUser.prototype.isValid=function(){return!this.getNameErr()&&!this.getPhoneErr()},ObjUser.prototype.getNameErr=function(){return this.name?"":"Name is required"},ObjUser.prototype.getPhoneErr=function(){return this.phone&&"null"!=this.phone?"":"Phone number is required"},ObjUser.fromJson=function(json){return new ObjUser(json.id,json.name,json.role,json.phone,json.countryCode,json.email,json.manager,json.about)},ObjUser.toJson=function(user){return{id:user.id,name:user.name,role:user.role,phone:user.phone,countryCode:user.countryCode,email:user.email,managerId:user.manager.id,about:user.about}},ObjUser}),app.factory("ObjColumn",function(ObjFilter){return function(id,name,type,fieldId,label){this.id=id,this.name=name,this.type=type,this.fieldId=fieldId,this.label=label,this.filter=new ObjFilter(type),this.size=Constants.Table.COL_SIZE_L}}),app.factory("ObjFilter",function(){function ObjFilter(fieldType){switch(fieldType){case Constants.Template.FIELD_TYPE_TEXT:case Constants.Template.FIELD_TYPE_RADIOLIST:case Constants.Template.FIELD_TYPE_CHECKLIST:case Constants.Template.FIELD_TYPE_CHECKBOX:this.type=Constants.Filter.TYPE_TEXT,this.value="";break;case Constants.Template.FIELD_TYPE_LEAD:case Constants.Template.FIELD_TYPE_TASK:this.type=Constants.Filter.TYPE_OBJECT,this.value="";break;case Constants.Template.FIELD_TYPE_NUMBER:this.type=Constants.Filter.TYPE_NUMBER,this.value={from:null,to:null};break;case Constants.Template.FIELD_TYPE_DATE:this.type=Constants.Filter.TYPE_DATE,this.value={from:null,to:null}}this.bNoBlanks=!1,this.bShow=!0,this.bSortable=function(){if(this.type==Constants.Template.FIELD_TYPE_PHOTO||this.type==Constants.Template.FIELD_TYPE_FILE||this.type==Constants.Template.FIELD_TYPE_SIGN||this.type==Constants.Template.FIELD_TYPE_LOCATION)return!1;return!0}(),this.sort=Constants.Table.SORT_NONE}return ObjFilter.prototype.toJson=function(){return{value:this.value,bNoBlanks:this.bNoBlanks}},ObjFilter}),app.factory("ObjTable",function($http,$q,$localStorage,FileService){return ObjTable=function(type){var vm=this;vm.type=type,vm.columns=[],vm.rows=[],vm.totalRows=0,vm.selectedRows=[],vm.pager={startIdx:0,count:Constants.Table.DEFAULT_COUNT_PER_PAGE},vm.sortOrder=[];var syncCanceller=null,bSyncOngoing=!1;function getFilter(){var colFilters=[];vm.columns.forEach(function(column){colFilters.push({colId:column.id,type:column.filter.type,value:column.filter.value,bNoBlanks:column.bNoBlanks})});var sortList=[];return vm.sortOrder.forEach(function(colId){var column=function(id){for(var i=0;i<vm.columns.length;i++)if(vm.columns[i].id==id)return vm.columns[i];return null}(colId);sortList.push({colId:colId,type:column.sortType})}),{pager:vm.pager,sortList:sortList,colFilters:colFilters}}vm.sync=function(bColumns){bSyncOngoing&&(syncCanceller.resolve(),bSyncOngoing=!1),syncCanceller=$q.defer();var deferred=$q.defer();return bSyncOngoing=!0,$http({method:"POST",url:"/api/manager/"+Constants.Table.URL_PREFIX[vm.type]+"/getTable",timeout:syncCanceller.promise,headers:{"X-Auth-Token":$localStorage.accessToken},data:{bColumns:bColumns,filter:getFilter()}}).then(function(response){bSyncOngoing=!1,function(data){data.columns&&(vm.columns=data.columns,vm.columns.forEach(function(column){column.filter=function(column){var filter={type:Constants.Filter.TYPE_NONE};switch(column.type){case Constants.Template.FIELD_TYPE_TEXT:case Constants.Template.FIELD_TYPE_RADIOLIST:case Constants.Template.FIELD_TYPE_CHECKLIST:case Constants.Template.FIELD_TYPE_CHECKBOX:filter.type=Constants.Filter.TYPE_TEXT,filter.value="";break;case Constants.Template.FIELD_TYPE_LEAD:case Constants.Template.FIELD_TYPE_TASK:filter.type=Constants.Filter.TYPE_OBJECT,filter.value="";break;case Constants.Template.FIELD_TYPE_NUMBER:filter.type=Constants.Filter.TYPE_NUMBER,filter.value={from:null,to:null};break;case Constants.Template.FIELD_TYPE_DATE:filter.type=Constants.Filter.TYPE_DATE,filter.value={from:null,to:null}}return filter}(column),column.sortType=Constants.Table.SORT_NONE,column.bNoBlanks=!1,column.bShow=!0}));vm.rows=data.rows,vm.totalRows=data.totalRows,vm.columns.forEach(function(column){if(column.type==Constants.Template.FIELD_TYPE_SIGN||column.type==Constants.Template.FIELD_TYPE_PHOTO||column.type==Constants.Template.FIELD_TYPE_FILE||column.type==Constants.Template.FIELD_TYPE_LOCATION)column.size=Constants.Table.COL_SIZE_S;else{var charCount=column.name.length;vm.rows.forEach(function(row){var value=row.values[column.id];charCount+=value.length});var charAvg=charCount/(vm.rows.length+1);column.size=charAvg<5?Constants.Table.COL_SIZE_S:charAvg<20?Constants.Table.COL_SIZE_M:Constants.Table.COL_SIZE_L}})}(response.data),deferred.resolve(null)},function(error){-1!=error.status&&(bSyncOngoing=!1,deferred.reject(null))}),deferred.promise},vm.export=function(){var order,deferred=$q.defer();return $http({method:"POST",url:"/api/manager/"+Constants.Table.URL_PREFIX[vm.type]+"/export",headers:{"X-Auth-Token":$localStorage.accessToken},responseType:"arraybuffer",data:{filter:getFilter(),exportParams:(order=[],vm.columns.forEach(function(column){column.bShow&&order.push(column.id)}),{selection:vm.getSelectedIds(),order:order})}}).then(function(response){FileService.download(response,"Navimate-"+Constants.Table.URL_PREFIX[vm.type]),deferred.resolve(null)},function(error){deferred.reject(error)}),deferred.promise},vm.selectAll=function(){var deferred=$q.defer();return $http({method:"POST",url:"/api/manager/"+Constants.Table.URL_PREFIX[vm.type]+"/getIds",headers:{"X-Auth-Token":$localStorage.accessToken},data:{filter:getFilter()}}).then(function(response){vm.selectedRows=response.data,deferred.resolve(null)},function(error){deferred.reject(error)}),deferred.promise},vm.reset=function(){vm.pager={startIdx:0,count:Constants.Table.DEFAULT_COUNT_PER_PAGE},vm.sortOrder=[],vm.selectedRows=[],vm.rows=[],vm.columns=[]},vm.getPageCount=function(){return Math.ceil(vm.totalRows/vm.pager.count)},vm.getSelectedIds=function(){var ids=[];return vm.selectedRows.forEach(function(row){ids.push(row.id)}),ids},vm.getSelectionIndex=function(id){for(var i=0;i<vm.selectedRows.length;i++){if(vm.selectedRows[i].id==id)return i}return-1}},ObjTable}),app.factory("ObjTable2",function($http,$q,$localStorage,FileService){return ObjTable2=function(type,getColumnsCb,parseServerResponseCb){var vm=this;vm.type=type,vm.columns=[],vm.rows=[],vm.rowCount=0,vm.selection=[],vm.pager={startIdx:0,count:Constants.Table.DEFAULT_COUNT_PER_PAGE},vm.pageCount=0,vm.sortOrder=[];var syncCanceller=null,bSyncOngoing=!1;function getFilters(){var colFilters={};return vm.columns.forEach(function(column){colFilters[column.label]=column.filter.toJson()}),colFilters}function getSorter(){var sorter=[];return vm.sortOrder.forEach(function(colId){var column=vm.getColumnById(colId),sortObj={};sortObj[column.label]=column.filter.sort,sorter.push(sortObj)}),sorter}vm.sync=function(){bSyncOngoing&&(syncCanceller.resolve(),bSyncOngoing=!1),syncCanceller=$q.defer();var deferred=$q.defer();return bSyncOngoing=!0,$http({method:"POST",url:"/api/manager/"+Constants.Table.URL_PREFIX[vm.type]+"/getTable",timeout:syncCanceller.promise,headers:{"X-Auth-Token":$localStorage.accessToken},data:{filter:getFilters(),sorter:getSorter(),pager:vm.pager}}).then(function(response){bSyncOngoing=!1,vm.rows=parseServerResponseCb(response.data),vm.rowCount=response.data.rowCount,vm.pageCount=Math.ceil(vm.rowCount/vm.pager.count),vm.columns.forEach(function(column){if(column.type==Constants.Template.FIELD_TYPE_SIGN||column.type==Constants.Template.FIELD_TYPE_PHOTO||column.type==Constants.Template.FIELD_TYPE_FILE||column.type==Constants.Template.FIELD_TYPE_LOCATION)column.size=Constants.Table.COL_SIZE_S;else{var charCount=column.name.length;vm.rows.forEach(function(row){var value=row.values[column.id];value&&(charCount+=value.length)});var charAvg=charCount/(vm.rows.length+1);column.size=charAvg<5?Constants.Table.COL_SIZE_S:charAvg<20?Constants.Table.COL_SIZE_M:Constants.Table.COL_SIZE_L}}),deferred.resolve(null)},function(error){-1!=error.status&&(bSyncOngoing=!1,deferred.reject(null))}),deferred.promise},vm.reset=function(){return vm.pager={startIdx:0,count:Constants.Table.DEFAULT_COUNT_PER_PAGE},vm.sortOrder=[],vm.columns=getColumnsCb(),vm.sync()},vm.export=function(){var params,deferred=$q.defer();return $http({method:"POST",url:"/api/manager/"+Constants.Table.URL_PREFIX[vm.type]+"/export",headers:{"X-Auth-Token":$localStorage.accessToken},responseType:"arraybuffer",data:{filter:getFilters(),sorter:getSorter(),exportParams:(params={columns:[],selection:vm.getSelectedIds()},vm.columns.forEach(function(column){column.filter.bShow&&params.columns.push({field:column.label,label:column.name,type:column.type})}),params)}}).then(function(response){FileService.download(response,"Navimate-"+Constants.Table.URL_PREFIX[vm.type]),deferred.resolve(null)},function(error){deferred.reject(error)}),deferred.promise},vm.selectAll=function(){var deferred=$q.defer();return $http({method:"POST",url:"/api/manager/"+Constants.Table.URL_PREFIX[vm.type]+"/getIds",headers:{"X-Auth-Token":$localStorage.accessToken},data:{filter:getFilters(),sorter:getSorter(),pager:vm.pager}}).then(function(response){vm.selection=response.data,deferred.resolve(null)},function(error){deferred.reject(error)}),deferred.promise},vm.getSelectedIds=function(){var ids=[];return vm.selection.forEach(function(row){ids.push(row.id)}),ids},vm.getSelectionIndex=function(id){for(var i=0;i<vm.selection.length;i++){if(vm.selection[i].id==id)return i}return-1},vm.getColumnForField=function(field){for(var colIdx=-1,i=0;i<vm.columns.length;i++)if(vm.columns[i].fieldId==field.id){colIdx=i;break}return 0<=colIdx?vm.columns[colIdx]:null},vm.getColumnById=function(id){for(var i=0;i<vm.columns.length;i++)if(vm.columns[i].id==id)return vm.columns[i];return null}},ObjTable2}),app.factory("ObjField",function(ObjFieldSettings){function ObjField(id,title,type,value){this.id=id,this.type=type,this.title=title,this.value=value,this.settings=new ObjFieldSettings(!1)}return ObjField.prototype.Clone=function(){var value=JSON.parse(JSON.stringify(this.value)),field=new ObjField(this.id,this.title,this.type,value);return field.settings=this.settings.Clone(),field},ObjField.fromJson=function(json){var field=new ObjField(json.id,json.title,json.type,Statics.getValueFromString(json.value,json.type));return field.settings=ObjFieldSettings.fromJson(json.settings),field},ObjField.toJson=function(field){return{id:field.id,title:field.title,type:field.type,value:Statics.getStringFromValue(field.value,field.type),settings:ObjFieldSettings.toJson(field.settings)}},ObjField}),app.factory("ObjFieldSettings",function(){function ObjFieldSettings(bMandatory){this.bMandatory=bMandatory}return ObjFieldSettings.prototype.Clone=function(){return new ObjFieldSettings(this.bMandatory)},ObjFieldSettings.fromJson=function(json){return new ObjFieldSettings(json.bMandatory)},ObjFieldSettings.toJson=function(settings){return{bMandatory:settings.bMandatory}},ObjFieldSettings}),app.factory("ObjValue",function(TemplateService){function ObjValue(value,field){this.value=value,this.field=field}return ObjValue.prototype.getDisplayString=function(){switch(this.field.type){case Constants.Template.FIELD_TYPE_DATE:if(this.value&&this.value.length)return moment(this.value,Constants.Date.FORMAT_LONG).format(Constants.Date.FORMAT_DESCRIPTIVE);break;case Constants.Template.FIELD_TYPE_RADIOLIST:if(this.value)return this.value.options[this.value.selection];break;case Constants.Template.FIELD_TYPE_CHECKLIST:if(this.value){var valueString="";return this.value.forEach(function(option){option.selection&&(valueString+=valueString?", "+option.name:option.name)}),valueString}}return this.value},ObjValue.prototype.getErr=function(){var err="";switch(this.field.type){case Constants.Template.FIELD_TYPE_TEXT:case Constants.Template.FIELD_TYPE_CHECKBOX:case Constants.Template.FIELD_TYPE_RADIOLIST:case Constants.Template.FIELD_TYPE_CHECKLIST:case Constants.Template.FIELD_TYPE_PHOTO:case Constants.Template.FIELD_TYPE_FILE:case Constants.Template.FIELD_TYPE_SIGN:case Constants.Template.FIELD_TYPE_LOCATION:case Constants.Template.FIELD_TYPE_DATE:this.field.settings.bMandatory&&(this.value||(err="Field is mandatory"));break;case Constants.Template.FIELD_TYPE_NUMBER:Statics.validateNumber(this.value)||(err="Cannot be empty");break;default:err="Invalid Field Type"}return err},ObjValue.prototype.Clone=function(){return ObjValue.fromJson(ObjValue.toJson(this))},ObjValue.fromJson=function(json){var field=TemplateService.getFieldById(json.fieldId);return new ObjValue(Statics.getValueFromString(json.value,field.type),field)},ObjValue.toJson=function(value){return{value:Statics.getStringFromValue(value.value,value.field.type),fieldId:value.field.id}},ObjValue});